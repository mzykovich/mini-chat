<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini Chat</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; background: #0b1220; color: #e6edf3; }
    .app { display:flex; height: 100vh; }
    .side { width: 280px; padding: 12px; border-right:1px solid #1f2a44; background:#0a1020; box-sizing: border-box; }
    .main { flex:1; display:flex; flex-direction:column; padding: 12px; box-sizing: border-box; }
    .card { background:#111a2e; border:1px solid #1f2a44; border-radius: 12px; padding: 10px; }
    .channels { margin-top: 10px; display:flex; flex-direction:column; gap:6px; }
    .ch {
      padding: 8px 10px;
      border-radius: 10px;
      border:1px solid #1f2a44;
      background:#0f172a;
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .ch:hover { filter: brightness(1.08); }
    .ch.active { outline: 2px solid #1f6feb; background:#0b1b3a; }

    .badge {
      min-width: 22px;
      height: 18px;
      padding: 0 6px;
      border-radius: 999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      background: #dc2626;
      color: white;
      border: 1px solid rgba(255,255,255,.15);
    }

    #log { flex:1; overflow:auto; padding: 12px; background:#0f172a; border-radius: 12px; border:1px solid #1f2a44; margin-top: 10px; }
    .msg { margin: 10px 0; }
    .meta { opacity:.75; font-size: 12px; display:flex; gap:10px; align-items:center; justify-content:space-between; }
    .bubble { display:inline-block; padding:10px 12px; border-radius: 12px; background:#1b243b; max-width: 100%; white-space: pre-wrap; }
    .row { display:flex; gap:10px; margin-top: 10px; }
    input, button { border-radius: 10px; border:1px solid #2a3a63; background:#0b1220; color:#e6edf3; padding: 10px; }
    input { flex: 1; }
    button { cursor:pointer; }
    button:disabled { opacity: .6; cursor:not-allowed; }
    .status { font-size: 12px; opacity:.8; margin-top: 8px; }

    /* –∫–Ω–æ–ø–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
    .copyBtn { opacity: 0; transition: opacity .15s ease; }
    .msg:hover .copyBtn { opacity: 1; }

    /* –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ */
    mark { background: rgba(255, 235, 59, 0.25); color: inherit; padding: 0 2px; border-radius: 4px; }
  </style>
</head>
<body>
<div class="app">
  <div class="side">
    <div class="card">
      <div><b>Mini Chat</b></div>
      <div class="status" id="presence">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ‚Ä¶</div>
      <div class="row" style="margin-top:8px;">
        <input id="name" placeholder="–¢–≤–æ–π –Ω–∏–∫" maxlength="32"/>
        <button id="saveName">OK</button>
      </div>
      <div class="status" style="opacity:.7;">Ctrl+K ‚Äî –ø–æ–∏—Å–∫ ‚Ä¢ Esc ‚Äî –æ—á–∏—Å—Ç–∏—Ç—å</div>
    </div>

    <div class="card" style="margin-top:10px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <b>–ö–∞–Ω–∞–ª—ã</b>
      </div>
      <div class="row" style="margin-top:8px;">
        <input id="newCh" placeholder="new-channel" maxlength="40"/>
        <button id="addCh">+</button>
      </div>
      <div class="channels" id="channels"></div>
    </div>
  </div>

  <div class="main">
    <div class="card" style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
      <div>
        <div><b id="title"># general</b></div>
        <div class="status" id="seen"></div>
      </div>

      <div style="display:flex; gap:8px; align-items:center;">
        <input id="search" placeholder="–ü–æ–∏—Å–∫ –≤ –∫–∞–Ω–∞–ª–µ‚Ä¶" style="max-width:260px;" />
        <button id="toBottom" title="–í–Ω–∏–∑" style="display:none;">‚¨áÔ∏è</button>
      </div>
    </div>

    <div class="status" id="typing" style="height:18px; margin-top:8px; opacity:.75;"></div>

    <div id="log"></div>

    <div class="row">
      <input id="text" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶" maxlength="2000" />
      <button id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<script>
  const log = document.getElementById("log");
  const text = document.getElementById("text");
  const sendBtn = document.getElementById("send");
  const nameInp = document.getElementById("name");
  const saveNameBtn = document.getElementById("saveName");
  const presenceEl = document.getElementById("presence");
  const seenEl = document.getElementById("seen");
  const titleEl = document.getElementById("title");
  const channelsEl = document.getElementById("channels");
  const newChInp = document.getElementById("newCh");
  const addChBtn = document.getElementById("addCh");
  const searchInp = document.getElementById("search");
  const toBottomBtn = document.getElementById("toBottom");
  const typingEl = document.getElementById("typing");

  let myName = localStorage.getItem("miniChatName") || "";
  if (myName) nameInp.value = myName;

  let currentChannel = localStorage.getItem("miniChatLastChannel") || "general";
  let lastSeq = 0;

  // channelsCache: [{name,lastId,readId,unread}]
  let channelsCache = [];
  let messagesCache = [];
  let lastDateLabel = "";

  const wsProto = location.protocol === "https:" ? "wss" : "ws";
  const ws = new WebSocket(`${wsProto}://${location.host}`);

  // —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
  presenceEl.textContent = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ‚Ä¶";
  ws.addEventListener("open", () => presenceEl.textContent = "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ");
  ws.addEventListener("close", () => presenceEl.textContent = "‚ö†Ô∏è –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ (–æ–±–Ω–æ–≤–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É)");
  ws.addEventListener("error", () => presenceEl.textContent = "‚ùå –û—à–∏–±–∫–∞ WebSocket");

  function escapeHtml(s) {
    return String(s || "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[c]));
  }

  function setTitle() {
    titleEl.textContent = `# ${currentChannel}`;
    localStorage.setItem("miniChatLastChannel", currentChannel);
  }

  function fmtBadge(n) {
    if (n <= 0) return "";
    if (n > 99) return "99+";
    return String(n);
  }

  function renderChannels(state) {
    channelsEl.innerHTML = "";
    for (const ch of state) {
      const row = document.createElement("div");
      row.className = "ch" + (ch.name === currentChannel ? " active" : "");

      const left = document.createElement("div");
      left.textContent = "# " + ch.name;

      const right = document.createElement("div");
      if (ch.name !== currentChannel && ch.unread > 0) {
        const b = document.createElement("span");
        b.className = "badge";
        b.textContent = fmtBadge(ch.unread);
        right.appendChild(b);
      }

      row.appendChild(left);
      row.appendChild(right);
      row.onclick = () => joinChannel(ch.name);

      channelsEl.appendChild(row);
    }
  }

  function joinChannel(ch) {
    currentChannel = ch;
    setTitle();

    // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∏—Å–∫/—Ä–µ–Ω–¥–µ—Ä
    searchInp.value = "";
    typingEl.textContent = "";
    messagesCache = [];
    lastDateLabel = "";
    log.innerHTML = "";
    lastSeq = 0;

    ws.send(JSON.stringify({ type: "join", channel: ch }));
  }

  function sendSeen(seq) {
    ws.send(JSON.stringify({ type: "seen", seq }));
  }

  // --- UI —Ñ–∏—à–∫–∏ ---
  function dateLabel(ts) {
    const d = new Date(ts);
    const today = new Date();
    const yd = new Date(Date.now() - 86400000);
    const dd = d.toDateString();
    if (dd === today.toDateString()) return "–°–µ–≥–æ–¥–Ω—è";
    if (dd === yd.toDateString()) return "–í—á–µ—Ä–∞";
    return d.toLocaleDateString();
  }

  function addDateDivider(ts) {
    const label = dateLabel(ts);
    if (label === lastDateLabel) return;
    lastDateLabel = label;

    const div = document.createElement("div");
    div.style.margin = "14px 0";
    div.style.display = "flex";
    div.style.alignItems = "center";
    div.style.gap = "10px";
    div.innerHTML = `
      <div style="height:1px; background:#1f2a44; flex:1;"></div>
      <div style="font-size:12px; opacity:.7;">${escapeHtml(label)}</div>
      <div style="height:1px; background:#1f2a44; flex:1;"></div>
    `;
    log.appendChild(div);
  }

  function highlight(text, q) {
    if (!q) return escapeHtml(text);
    const safeText = escapeHtml(text);
    // –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –±–µ–∑ —Ä–µ–≥–µ–∫—Å–ø-—Å–ª–æ–∂–Ω–æ—Å—Ç–µ–π: –ø—Ä–æ—Å—Ç–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ
    const idx = safeText.toLowerCase().indexOf(q.toLowerCase());
    if (idx < 0) return safeText;
    const a = safeText.slice(0, idx);
    const b = safeText.slice(idx, idx + q.length);
    const c = safeText.slice(idx + q.length);
    return `${a}<mark>${b}</mark>${c}`;
  }

  function addMessage(m) {
    addDateDivider(m.at);

    const div = document.createElement("div");
    div.className = "msg";

    const at = new Date(m.at).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
    const q = (searchInp.value || "").trim();

    div.innerHTML = `
      <div class="meta">
        <span>${escapeHtml(m.from)} ‚Ä¢ ${at}</span>
        <button class="copyBtn" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å" style="padding:6px 8px; font-size:12px;">üìã</button>
      </div>
      <div class="bubble">${highlight(m.text || "", q)}</div>
    `;

    div.querySelector(".copyBtn").onclick = async () => {
      try {
        await navigator.clipboard.writeText(m.text || "");
        const btn = div.querySelector(".copyBtn");
        const old = btn.textContent;
        btn.textContent = "‚úÖ";
        setTimeout(() => (btn.textContent = old), 700);
      } catch {
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å");
      }
    };

    log.appendChild(div);
  }

  function renderFromCache() {
    log.innerHTML = "";
    lastDateLabel = "";

    const q = (searchInp.value || "").trim().toLowerCase();
    const list = q
      ? messagesCache.filter(m => (m.text || "").toLowerCase().includes(q))
      : messagesCache;

    for (const m of list) addMessage(m);
    log.scrollTop = log.scrollHeight;
  }

  searchInp.addEventListener("input", renderFromCache);

  // Ctrl+K —Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–∏—Å–∫, Esc –æ—á–∏—Å—Ç–∏—Ç—å
  document.addEventListener("keydown", (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k") {
      e.preventDefault();
      searchInp.focus();
    }
    if (e.key === "Escape") {
      if (document.activeElement === searchInp || (searchInp.value || "").trim()) {
        searchInp.value = "";
        renderFromCache();
        text.focus();
      }
    }
  });

  let typingTimer = null;
  text.addEventListener("input", () => {
    typingEl.textContent = "–¢—ã –ø–µ—á–∞—Ç–∞–µ—à—å‚Ä¶";
    clearTimeout(typingTimer);
    typingTimer = setTimeout(() => (typingEl.textContent = ""), 600);
  });

  function nearBottom() {
    return (log.scrollHeight - log.scrollTop - log.clientHeight) < 120;
  }

  log.addEventListener("scroll", () => {
    toBottomBtn.style.display = nearBottom() ? "none" : "inline-block";
  });

  toBottomBtn.addEventListener("click", () => {
    log.scrollTop = log.scrollHeight;
  });

  // --- WS handlers ---
  ws.addEventListener("open", () => {
    if (myName) ws.send(JSON.stringify({ type: "hello", name: myName }));
    setTitle();
    // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–Ω–µ–µ –±—ã–ª –≤ –¥—Ä—É–≥–æ–º –∫–∞–Ω–∞–ª–µ ‚Äî —Å—Ä–∞–∑—É –∑–∞–π–¥—ë–º —Ç—É–¥–∞
    if (currentChannel && currentChannel !== "general") {
      ws.send(JSON.stringify({ type: "join", channel: currentChannel }));
    }
  });

  ws.addEventListener("message", (ev) => {
    const msg = JSON.parse(ev.data);

    // —Å—Ç–∞—Ä—ã–π —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
    if (msg.type === "channels") {
      // –Ω–∏—á–µ–≥–æ –∫—Ä–∏—Ç–∏—á–Ω–æ–≥–æ: –∂–¥—ë–º channels_state –¥–ª—è –±–µ–π–¥–∂–µ–π
      return;
    }

    // –Ω–æ–≤–æ–µ: —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤ + unread
    if (msg.type === "channels_state") {
      channelsCache = msg.channels || [];
      // –µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –∫–∞–Ω–∞–ª –∏—Å—á–µ–∑ (—Ä–µ–¥–∫–æ) ‚Äî –æ—Ç–∫–∞—Ç–∏–º—Å—è
      if (!channelsCache.some(c => c.name === currentChannel) && channelsCache.length) {
        currentChannel = channelsCache[0].name;
        setTitle();
        ws.send(JSON.stringify({ type: "join", channel: currentChannel }));
      }
      renderChannels(channelsCache);
      return;
    }

    if (msg.type === "joined") {
      currentChannel = msg.channel;
      setTitle();
      // –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞
      renderChannels(channelsCache);
      return;
    }

    if (msg.type === "history") {
      if (msg.channel !== currentChannel) return;

      messagesCache = (msg.messages || []);
      lastSeq = 0;
      for (const m of messagesCache) lastSeq = Math.max(lastSeq, m.id);

      renderFromCache();

      if (lastSeq > 0) sendSeen(lastSeq);
      return;
    }

    if (msg.type === "chat") {
      if (msg.channel !== currentChannel) return;

      messagesCache.push(msg.message);
      lastSeq = Math.max(lastSeq, msg.message.id);

      if ((searchInp.value || "").trim()) {
        renderFromCache();
      } else {
        addMessage(msg.message);
        if (nearBottom()) log.scrollTop = log.scrollHeight;
      }

      if (document.visibilityState === "visible") sendSeen(lastSeq);
      return;
    }

    if (msg.type === "seen_state") {
      if (msg.channel !== currentChannel) return;

      if (msg.lastSeq === 0) seenEl.textContent = "";
      else {
        const allRead = (msg.readUpTo >= msg.lastSeq);
        seenEl.textContent = allRead
          ? `‚úÖ –ü—Ä–æ—á–∏—Ç–∞–Ω–æ –≤—Å–µ–º–∏ (–æ–Ω–ª–∞–π–Ω: ${msg.connected})`
          : `‚åõ –ü—Ä–æ—á–∏—Ç–∞–Ω–æ –¥–æ #${msg.readUpTo} –∏–∑ #${msg.lastSeq} (–æ–Ω–ª–∞–π–Ω: ${msg.connected})`;
      }
      return;
    }

    if (msg.type === "presence") {
      // –µ—Å–ª–∏ —Ö–æ—á–µ—à—å: –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ–Ω–ª–∞–π–Ω-—Å–ø–∏—Å–æ–∫. –°–µ–π—á–∞—Å –º—ã –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è,
      // –Ω–æ –º–æ–∂–Ω–æ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫—É –Ω–∏–∂–µ:
      // presenceEl.textContent = `–û–Ω–ª–∞–π–Ω: ${(msg.users || []).join(", ") || "–Ω–∏–∫–æ–≥–æ"}`;
      return;
    }
  });

  function sendMsg() {
    const v = text.value.trim();
    if (!v) return;
    ws.send(JSON.stringify({ type: "chat", text: v }));
    text.value = "";
    text.focus();
  }

  sendBtn.addEventListener("click", sendMsg);
  text.addEventListener("keydown", (e) => { if (e.key === "Enter") sendMsg(); });

  function saveName() {
    myName = nameInp.value.trim().slice(0, 32) || "–ì–æ—Å—Ç—å";
    localStorage.setItem("miniChatName", myName);
    if (ws.readyState === 1) ws.send(JSON.stringify({ type: "hello", name: myName }));
  }
  saveNameBtn.addEventListener("click", saveName);

  addChBtn.addEventListener("click", () => {
    const name = newChInp.value.trim();
    if (!name) return;
    ws.send(JSON.stringify({ type: "create_channel", name }));
    newChInp.value = "";
  });

  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible" && lastSeq > 0 && ws.readyState === 1) {
      sendSeen(lastSeq);
    }
  });
</script>
</body>
</html>
