<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini Chat</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; background: #0b1220; color: #e6edf3; }
    .app { display:flex; height: 100vh; }
    .side { width: 260px; padding: 12px; border-right:1px solid #1f2a44; background:#0a1020; box-sizing: border-box; }
    .main { flex:1; display:flex; flex-direction:column; padding: 12px; box-sizing: border-box; }
    .card { background:#111a2e; border:1px solid #1f2a44; border-radius: 12px; padding: 10px; }
    .channels { margin-top: 10px; display:flex; flex-direction:column; gap:6px; }
    .ch { padding: 8px 10px; border-radius: 10px; border:1px solid #1f2a44; background:#0f172a; cursor:pointer; user-select:none; }
    .ch:hover { filter: brightness(1.08); }
    .ch.active { outline: 2px solid #1f6feb; background:#0b1b3a; }
    #log { flex:1; overflow:auto; padding: 12px; background:#0f172a; border-radius: 12px; border:1px solid #1f2a44; margin-top: 10px; }
    .msg { margin: 8px 0; }
    .meta { opacity:.75; font-size: 12px; }
    .bubble { display:inline-block; padding:10px 12px; border-radius: 12px; background:#1b243b; max-width: 100%; white-space: pre-wrap; }
    .row { display:flex; gap:10px; margin-top: 10px; }
    input, button { border-radius: 10px; border:1px solid #2a3a63; background:#0b1220; color:#e6edf3; padding: 10px; }
    input { flex: 1; }
    button { cursor:pointer; }
    button:disabled { opacity: .6; cursor:not-allowed; }
    .status { font-size: 12px; opacity:.8; margin-top: 8px; }
  </style>
</head>
<body>
<div class="app">
  <div class="side">
    <div class="card">
      <div><b>Mini Chat</b></div>
      <div class="status" id="presence">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ‚Ä¶</div>
      <div class="row" style="margin-top:8px;">
        <input id="name" placeholder="–¢–≤–æ–π –Ω–∏–∫" maxlength="32"/>
        <button id="saveName">OK</button>
      </div>
    </div>

    <div class="card" style="margin-top:10px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <b>–ö–∞–Ω–∞–ª—ã</b>
      </div>
      <div class="row" style="margin-top:8px;">
        <input id="newCh" placeholder="new-channel" maxlength="40"/>
        <button id="addCh">+</button>
      </div>
      <div class="channels" id="channels"></div>
    </div>
  </div>

  <div class="main">
    <div class="card" style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
      <div>
        <div><b id="title"># general</b></div>
        <div class="status" id="seen"></div>
      </div>

      <div style="display:flex; gap:8px; align-items:center;">
        <input id="search" placeholder="–ü–æ–∏—Å–∫ –≤ –∫–∞–Ω–∞–ª–µ‚Ä¶" style="max-width:260px;" />
        <button id="toBottom" title="–í–Ω–∏–∑" style="display:none;">‚¨áÔ∏è</button>
      </div>
    </div>

    <div class="status" id="typing" style="height:18px; margin-top:8px; opacity:.75;"></div>

    <div id="log"></div>

    <div class="row">
      <input id="text" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶" maxlength="2000" />
      <button id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<script>
  const log = document.getElementById("log");
  const text = document.getElementById("text");
  const sendBtn = document.getElementById("send");
  const nameInp = document.getElementById("name");
  const saveNameBtn = document.getElementById("saveName");
  const presenceEl = document.getElementById("presence");
  const seenEl = document.getElementById("seen");
  const titleEl = document.getElementById("title");
  const channelsEl = document.getElementById("channels");
  const newChInp = document.getElementById("newCh");
  const addChBtn = document.getElementById("addCh");
  const searchInp = document.getElementById("search");
  const toBottomBtn = document.getElementById("toBottom");
  const typingEl = document.getElementById("typing");

  let myName = localStorage.getItem("miniChatName") || "";
  if (myName) nameInp.value = myName;

  let currentChannel = "general";
  let lastSeq = 0;

  let channelsCache = [];   // –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞
  let messagesCache = [];   // —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –∫–∞–Ω–∞–ª–∞ (–¥–ª—è –ø–æ–∏—Å–∫–∞/—Ä–µ–Ω–¥–µ—Ä–∞)
  let lastDateLabel = "";   // –¥–ª—è —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π –¥–∞—Ç

  const wsProto = location.protocol === "https:" ? "wss" : "ws";
  const ws = new WebSocket(`${wsProto}://${location.host}`);

  // –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (—á—Ç–æ–±—ã –Ω–µ –≤–∏—Å–µ–ª–æ ‚Äú–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ‚Ä¶‚Äù)
  presenceEl.textContent = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ‚Ä¶";
  ws.addEventListener("open", () => {
    presenceEl.textContent = "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ";
  });
  ws.addEventListener("close", () => {
    presenceEl.textContent = "‚ö†Ô∏è –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ (–æ–±–Ω–æ–≤–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É)";
  });
  ws.addEventListener("error", () => {
    presenceEl.textContent = "‚ùå –û—à–∏–±–∫–∞ WebSocket";
  });

  function escapeHtml(s) {
    return String(s || "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[c]));
  }

  function setTitle() {
    titleEl.textContent = `# ${currentChannel}`;
  }

  function renderChannels(list) {
    channelsEl.innerHTML = "";
    for (const ch of list) {
      const b = document.createElement("div");
      b.className = "ch" + (ch === currentChannel ? " active" : "");
      b.textContent = "# " + ch;
      b.onclick = () => joinChannel(ch);
      channelsEl.appendChild(b);
    }
  }

  function joinChannel(ch) {
    currentChannel = ch;
    setTitle();

    // –æ—á–∏—Å—Ç–∫–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–∞–Ω–∞–ª–∞
    searchInp.value = "";
    typingEl.textContent = "";
    messagesCache = [];
    lastDateLabel = "";
    log.innerHTML = "";
    lastSeq = 0;

    ws.send(JSON.stringify({ type: "join", channel: ch }));
  }

  function sendSeen(seq) {
    ws.send(JSON.stringify({ type: "seen", seq }));
  }

  // --- UI —Ñ–∏—à–∫–∏ ---
  function dateLabel(ts) {
    const d = new Date(ts);
    const today = new Date();
    const yd = new Date(Date.now() - 86400000);

    const dd = d.toDateString();
    if (dd === today.toDateString()) return "–°–µ–≥–æ–¥–Ω—è";
    if (dd === yd.toDateString()) return "–í—á–µ—Ä–∞";
    return d.toLocaleDateString();
  }

  function addDateDivider(ts) {
    const label = dateLabel(ts);
    if (label === lastDateLabel) return;
    lastDateLabel = label;

    const div = document.createElement("div");
    div.style.margin = "14px 0";
    div.style.display = "flex";
    div.style.alignItems = "center";
    div.style.gap = "10px";
    div.innerHTML = `
      <div style="height:1px; background:#1f2a44; flex:1;"></div>
      <div style="font-size:12px; opacity:.7;">${escapeHtml(label)}</div>
      <div style="height:1px; background:#1f2a44; flex:1;"></div>
    `;
    log.appendChild(div);
  }

  function addMessage(m) {
    addDateDivider(m.at);

    const div = document.createElement("div");
    div.className = "msg";
    div.dataset.id = String(m.id || "");
    div.dataset.text = m.text || "";

    const at = new Date(m.at).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
    div.innerHTML = `
      <div class="meta" style="display:flex; gap:10px; align-items:center; justify-content:space-between;">
        <span>${escapeHtml(m.from)} ‚Ä¢ ${at}</span>
        <button class="copyBtn" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å" style="padding:6px 8px; font-size:12px;">üìã</button>
      </div>
      <div class="bubble">${escapeHtml(m.text || "")}</div>
    `;

    div.querySelector(".copyBtn").onclick = async () => {
      try {
        await navigator.clipboard.writeText(m.text || "");
        const btn = div.querySelector(".copyBtn");
        const old = btn.textContent;
        btn.textContent = "‚úÖ";
        setTimeout(() => (btn.textContent = old), 700);
      } catch {
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å");
      }
    };

    log.appendChild(div);
  }

  function renderFromCache() {
    log.innerHTML = "";
    lastDateLabel = "";

    const q = (searchInp.value || "").trim().toLowerCase();
    const list = q
      ? messagesCache.filter(m => (m.text || "").toLowerCase().includes(q))
      : messagesCache;

    for (const m of list) addMessage(m);
    log.scrollTop = log.scrollHeight;
  }

  searchInp.addEventListener("input", renderFromCache);

  let typingTimer = null;
  text.addEventListener("input", () => {
    typingEl.textContent = "–¢—ã –ø–µ—á–∞—Ç–∞–µ—à—å‚Ä¶";
    clearTimeout(typingTimer);
    typingTimer = setTimeout(() => (typingEl.textContent = ""), 600);
  });

  function nearBottom() {
    return (log.scrollHeight - log.scrollTop - log.clientHeight) < 120;
  }

  log.addEventListener("scroll", () => {
    toBottomBtn.style.display = nearBottom() ? "none" : "inline-block";
  });

  toBottomBtn.addEventListener("click", () => {
    log.scrollTop = log.scrollHeight;
  });

  // --- WebSocket handlers ---
  ws.addEventListener("open", () => {
    if (myName) ws.send(JSON.stringify({ type: "hello", name: myName }));
    setTitle();
  });

  ws.addEventListener("message", (ev) => {
    const msg = JSON.parse(ev.data);

    if (msg.type === "channels") {
      channelsCache = msg.channels || [];
      renderChannels(channelsCache);
      return;
    }

    if (msg.type === "joined") {
      currentChannel = msg.channel;
      setTitle();
      if (channelsCache.length) renderChannels(channelsCache); // —á—Ç–æ–±—ã –æ–±–≤–æ–¥–∫–∞ –æ–±–Ω–æ–≤–∏–ª–∞—Å—å
      return;
    }

    if (msg.type === "history") {
      if (msg.channel !== currentChannel) return;

      messagesCache = (msg.messages || []);
      lastSeq = 0;
      for (const m of messagesCache) lastSeq = Math.max(lastSeq, m.id);

      renderFromCache();

      if (lastSeq > 0) sendSeen(lastSeq);
      return;
    }

    if (msg.type === "chat") {
      if (msg.channel !== currentChannel) return;

      messagesCache.push(msg.message);
      lastSeq = Math.max(lastSeq, msg.message.id);

      // –µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω –ø–æ–∏—Å–∫ ‚Äî –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏–º, –∏–Ω–∞—á–µ –¥–æ–±–∞–≤–∏–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤–æ–µ
      if ((searchInp.value || "").trim()) {
        renderFromCache();
      } else {
        addMessage(msg.message);
        if (nearBottom()) log.scrollTop = log.scrollHeight;
      }

      if (document.visibilityState === "visible") sendSeen(lastSeq);
      return;
    }

    if (msg.type === "seen_state") {
      if (msg.channel !== currentChannel) return;

      if (msg.lastSeq === 0) seenEl.textContent = "";
      else {
        const allRead = (msg.readUpTo >= msg.lastSeq);
        seenEl.textContent = allRead
          ? `‚úÖ –ü—Ä–æ—á–∏—Ç–∞–Ω–æ –≤—Å–µ–º–∏ (–æ–Ω–ª–∞–π–Ω: ${msg.connected})`
          : `‚åõ –ü—Ä–æ—á–∏—Ç–∞–Ω–æ –¥–æ #${msg.readUpTo} –∏–∑ #${msg.lastSeq} (–æ–Ω–ª–∞–π–Ω: ${msg.connected})`;
      }
      return;
    }

    // –ï—Å–ª–∏ —É —Ç–µ–±—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –µ—Å—Ç—å presence ‚Äî —ç—Ç–æ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.
    if (msg.type === "presence") {
      presenceEl.textContent = `–û–Ω–ª–∞–π–Ω: ${(msg.users || []).join(", ") || "–Ω–∏–∫–æ–≥–æ"}`;
      return;
    }
  });

  function send() {
    const v = text.value.trim();
    if (!v) return;
    ws.send(JSON.stringify({ type: "chat", text: v }));
    text.value = "";
    text.focus();
  }

  sendBtn.addEventListener("click", send);
  text.addEventListener("keydown", (e) => { if (e.key === "Enter") send(); });

  function saveName() {
    myName = nameInp.value.trim().slice(0, 32) || "–ì–æ—Å—Ç—å";
    localStorage.setItem("miniChatName", myName);
    if (ws.readyState === 1) ws.send(JSON.stringify({ type: "hello", name: myName }));
  }
  saveNameBtn.addEventListener("click", saveName);

  addChBtn.addEventListener("click", () => {
    const name = newChInp.value.trim();
    if (!name) return;
    ws.send(JSON.stringify({ type: "create_channel", name }));
    newChInp.value = "";
  });

  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible" && lastSeq > 0 && ws.readyState === 1) {
      sendSeen(lastSeq);
    }
  });
</script>
</body>
</html>
