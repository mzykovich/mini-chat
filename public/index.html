<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Corp Chat Template</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; background:#0b1220; color:#e6edf3; }
    .app { display:flex; height:100vh; }
    .side { width:320px; padding:12px; border-right:1px solid #1f2a44; background:#0a1020; box-sizing:border-box; overflow:auto; }
    .main { flex:1; display:flex; flex-direction:column; padding:12px; box-sizing:border-box; }
    .card { background:#111a2e; border:1px solid #1f2a44; border-radius:12px; padding:10px; }
    .row { display:flex; gap:10px; margin-top:10px; }
    input, select, button, textarea { border-radius:10px; border:1px solid #2a3a63; background:#0b1220; color:#e6edf3; padding:10px; }
    input, select, textarea { width:100%; box-sizing:border-box; }
    button { cursor:pointer; white-space:nowrap; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .muted { opacity:.75; font-size:12px; }
    .list { margin-top:10px; display:flex; flex-direction:column; gap:6px; }
    .item { padding:8px 10px; border-radius:10px; border:1px solid #1f2a44; background:#0f172a; cursor:pointer; user-select:none; }
    .item:hover { filter:brightness(1.08); }
    .item.active { outline:2px solid #1f6feb; background:#0b1b3a; }

    #log { flex:1; overflow:auto; padding:12px; background:#0f172a; border-radius:12px; border:1px solid #1f2a44; margin-top:10px; }
    .msg { margin:10px 0; }
    .meta { opacity:.75; font-size:12px; display:flex; justify-content:space-between; gap:10px; align-items:center; }
    .bubble { display:inline-block; padding:10px 12px; border-radius:12px; background:#1b243b; white-space:pre-wrap; max-width:100%; }
    .receipt { opacity:.8; font-size:12px; margin-left:10px; }
    .dot { width:8px; height:8px; border-radius:999px; display:inline-block; vertical-align:middle; margin-right:6px; border:1px solid #2a3a63; }
    .dot.on { background:#22c55e; }
    .dot.off { background:#0b1220; }

    .tabs { display:flex; gap:8px; margin-top:10px; overflow-x:auto; padding-bottom:6px; scrollbar-width: thin; }
    .tab { flex:0 0 auto; padding:8px 10px; border-radius:10px; border:1px solid #1f2a44; background:#0f172a; cursor:pointer; user-select:none; }
    .tab.active { outline:2px solid #1f6feb; background:#0b1b3a; }
    .hidden { display:none !important; }

    .grid2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .hr { height:1px; background:#1f2a44; margin:10px 0; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; font-size:12px; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #2a3a63; background:#0b1220; font-size:12px; opacity:.9; }
    .danger { border-color:#7f1d1d !important; }

    #adminCard { max-height: 72vh; overflow:auto; }
  </style>
</head>
<body>
<div class="app">
  <div class="side">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <div>
          <div><b id="brand">Corp Chat</b></div>
          <div class="muted" id="status">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏‚Ä¶</div>
        </div>
        <button id="logoutBtn" class="hidden">–í—ã–π—Ç–∏</button>
      </div>

      <div id="authBox" class="row" style="flex-direction:column;">
        <div class="tabs">
          <div id="tabLogin" class="tab active">–í—Ö–æ–¥</div>
          <div id="tabRegister" class="tab">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
        </div>

        <div id="loginForm">
          <div class="row" style="margin-top:0;">
            <input id="loginEmail" placeholder="Email" />
          </div>
          <div class="row">
            <input id="loginPass" placeholder="–ü–∞—Ä–æ–ª—å" type="password" />
          </div>
          <div class="row">
            <button id="loginBtn">–í–æ–π—Ç–∏</button>
          </div>
          <div class="muted" id="loginMsg"></div>
        </div>

        <div id="registerForm" class="hidden">
          <div class="row" style="margin-top:0;">
            <input id="regName" placeholder="–ò–º—è (–∫–∞–∫ –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ –≤ —á–∞—Ç–µ)" />
          </div>
          <div class="row">
            <input id="regEmail" placeholder="Email" />
          </div>
          <div class="row">
            <input id="regPass" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω 6 —Å–∏–º–≤–æ–ª–æ–≤)" type="password" />
          </div>
          <div class="row">
            <select id="regPosition"></select>
          </div>
          <div class="row">
            <button id="registerBtn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
          </div>
          <div class="muted" id="registerMsg"></div>
        </div>
      </div>

      <div id="meBox" class="hidden" style="margin-top:10px;">
        <div><b id="meName"></b> <span class="pill" id="meRole"></span></div>
        <div class="muted" id="meEmail"></div>
      </div>
    </div>

    <div id="channelsCard" class="card hidden" style="margin-top:10px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <b>–ö–∞–Ω–∞–ª—ã</b>
        <button id="openAdminBtn" class="hidden">–ê–¥–º–∏–Ω–∫–∞</button>
      </div>
      <div class="list" id="channels"></div>
      <div class="muted">–í —Å–ø–∏—Å–∫–µ —Ç–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ–±–µ –∫–∞–Ω–∞–ª—ã</div>
    </div>

    <!-- –ê–¥–º–∏–Ω–∫–∞ (–æ—Å—Ç–∞–≤–∏–ª –∫–∞–∫ —É —Ç–µ–±—è –±—ã–ª–æ) -->
    <div id="adminCard" class="card hidden" style="margin-top:10px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <b>–ê–¥–º–∏–Ω–∫–∞</b>
        <button id="closeAdminBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>

      <div class="tabs">
        <div class="tab active" data-admin-tab="roles">–†–æ–ª–∏</div>
        <div class="tab" data-admin-tab="users">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
        <div class="tab" data-admin-tab="channels">–ö–∞–Ω–∞–ª—ã</div>
        <div class="tab" data-admin-tab="audit">–ê—É–¥–∏—Ç</div>
      </div>

      <div id="adminRoles">
        <div class="muted">–ö–∞—Å—Ç–æ–º–Ω—ã–µ —Ä–æ–ª–∏ (–¥–æ–ª–∂–Ω–æ—Å—Ç–∏).</div>
        <div class="row">
          <input id="newRoleName" placeholder="role-slug (–Ω–∞–ø—Ä–∏–º–µ—Ä sales-manager)" />
        </div>
        <div class="row">
          <input id="newRoleDisplay" placeholder="–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä –ú–µ–Ω–µ–¥–∂–µ—Ä)" />
          <button id="createRoleBtn">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
        <div class="hr"></div>
        <div id="rolesList" class="muted"></div>
      </div>

      <div id="adminUsers" class="hidden">
        <div class="muted">–í—ã–¥–∞–≤–∞–π –∏ —Å–Ω–∏–º–∞–π —Ä–æ–ª–∏.</div>
        <div class="hr"></div>
        <div id="usersList"></div>
      </div>

      <div id="adminChannels" class="hidden">
        <div class="muted">–ö–∞–Ω–∞–ª—ã –∏ –¥–æ—Å—Ç—É–ø.</div>
        <div class="row">
          <input id="newChannelName" placeholder="channel-name" />
        </div>
        <div class="row">
          <select id="newChannelPublic">
            <option value="true">–ü—É–±–ª–∏—á–Ω—ã–π (–≤—Å–µ–º)</option>
            <option value="false">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π (–ø–æ –¥–æ—Å—Ç—É–ø—É)</option>
          </select>
          <button id="createChannelBtn">–°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª</button>
        </div>

        <div class="hr"></div>

        <div class="muted">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ—Å—Ç—É–ø–∞:</div>
        <div class="row">
          <select id="accessChannel"></select>
          <button id="loadAccessBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ—Å—Ç—É–ø</button>
        </div>

        <div class="grid2">
          <div>
            <div class="muted">–†–æ–ª–∏ —Å –¥–æ—Å—Ç—É–ø–æ–º</div>
            <div id="accessRoles"></div>
          </div>
          <div>
            <div class="muted">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –¥–æ—Å—Ç—É–ø–æ–º</div>
            <div id="accessUsers"></div>
          </div>
        </div>

        <div class="row">
          <button id="saveAccessBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–æ—Å—Ç—É–ø</button>
        </div>
        <div class="muted" id="accessMsg"></div>
      </div>

      <div id="adminAudit" class="hidden">
        <div class="muted">–ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π (OWNER/SUPERADMIN).</div>
        <div class="hr"></div>
        <div id="auditList" class="muted"></div>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="card">
      <div><b id="title">‚Äî</b></div>
      <div class="muted" id="hint">–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏/–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è</div>
    </div>

    <div id="log"></div>

    <div class="row">
      <input id="text" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶" maxlength="2000" disabled />
      <button id="send" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<script>
  const statusEl = document.getElementById("status");
  const authBox = document.getElementById("authBox");
  const meBox = document.getElementById("meBox");
  const meNameEl = document.getElementById("meName");
  const meEmailEl = document.getElementById("meEmail");
  const meRoleEl = document.getElementById("meRole");
  const logoutBtn = document.getElementById("logoutBtn");

  const tabLogin = document.getElementById("tabLogin");
  const tabRegister = document.getElementById("tabRegister");
  const loginForm = document.getElementById("loginForm");
  const registerForm = document.getElementById("registerForm");

  const loginEmail = document.getElementById("loginEmail");
  const loginPass = document.getElementById("loginPass");
  const loginBtn = document.getElementById("loginBtn");
  const loginMsg = document.getElementById("loginMsg");

  const regName = document.getElementById("regName");
  const regEmail = document.getElementById("regEmail");
  const regPass = document.getElementById("regPass");
  const regPosition = document.getElementById("regPosition");
  const registerBtn = document.getElementById("registerBtn");
  const registerMsg = document.getElementById("registerMsg");

  const channelsCard = document.getElementById("channelsCard");
  const channelsEl = document.getElementById("channels");
  const titleEl = document.getElementById("title");
  const hintEl = document.getElementById("hint");

  const log = document.getElementById("log");
  const text = document.getElementById("text");
  const sendBtn = document.getElementById("send");

  const openAdminBtn = document.getElementById("openAdminBtn");
  const adminCard = document.getElementById("adminCard");
  const closeAdminBtn = document.getElementById("closeAdminBtn");

  // admin elements
  const rolesList = document.getElementById("rolesList");
  const usersList = document.getElementById("usersList");
  const auditList = document.getElementById("auditList");
  const newRoleName = document.getElementById("newRoleName");
  const newRoleDisplay = document.getElementById("newRoleDisplay");
  const createRoleBtn = document.getElementById("createRoleBtn");
  const newChannelName = document.getElementById("newChannelName");
  const newChannelPublic = document.getElementById("newChannelPublic");
  const createChannelBtn = document.getElementById("createChannelBtn");
  const accessChannel = document.getElementById("accessChannel");
  const loadAccessBtn = document.getElementById("loadAccessBtn");
  const accessRoles = document.getElementById("accessRoles");
  const accessUsers = document.getElementById("accessUsers");
  const saveAccessBtn = document.getElementById("saveAccessBtn");
  const accessMsg = document.getElementById("accessMsg");

  const adminTabs = [...document.querySelectorAll("[data-admin-tab]")];
  const adminViews = {
    roles: document.getElementById("adminRoles"),
    users: document.getElementById("adminUsers"),
    channels: document.getElementById("adminChannels"),
    audit: document.getElementById("adminAudit"),
  };

  let me = null;
  let ws = null;
  let channels = [];
  let activeChannelId = null;

  let roles = [];
  let users = [];
  let adminAllChannels = [];

  // presence + receipts
  let onlineUserIds = new Set(); // userId
  let receiptByMessageId = new Map(); // msgId -> {readCount,total}

  function esc(s) {
    return String(s || "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[c]));
  }

  async function api(path, opts) {
    const res = await fetch(path, { credentials: "include", ...opts });
    const data = await res.json().catch(() => ({}));
    if (!res.ok || data.ok === false) throw new Error(data.message || data.code || "Request failed");
    return data;
  }

  function setAuthMode(mode) {
    if (mode === "login") {
      tabLogin.classList.add("active");
      tabRegister.classList.remove("active");
      loginForm.classList.remove("hidden");
      registerForm.classList.add("hidden");
    } else {
      tabRegister.classList.add("active");
      tabLogin.classList.remove("active");
      registerForm.classList.remove("hidden");
      loginForm.classList.add("hidden");
    }
  }

  tabLogin.onclick = () => setAuthMode("login");
  tabRegister.onclick = () => setAuthMode("register");

  function dotHtml(isOn) {
    return `<span class="dot ${isOn ? "on" : "off"}"></span>`;
  }

  function uiLoggedOut() {
    me = null;
    authBox.classList.remove("hidden");
    meBox.classList.add("hidden");
    logoutBtn.classList.add("hidden");
    channelsCard.classList.add("hidden");
    adminCard.classList.add("hidden");
    openAdminBtn.classList.add("hidden");

    titleEl.textContent = "‚Äî";
    hintEl.textContent = "–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏/–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è";
    text.disabled = true;
    sendBtn.disabled = true;
    log.innerHTML = "";

    onlineUserIds = new Set();
    receiptByMessageId = new Map();

    if (ws) { try { ws.close(); } catch {} }
    ws = null;
  }

  function uiLoggedIn() {
    authBox.classList.add("hidden");
    meBox.classList.remove("hidden");
    logoutBtn.classList.remove("hidden");
    channelsCard.classList.remove("hidden");
    hintEl.textContent = "–í—ã–±–µ—Ä–∏ –∫–∞–Ω–∞–ª —Å–ª–µ–≤–∞";
    text.disabled = false;
    sendBtn.disabled = false;

    meNameEl.textContent = me.displayName;
    meEmailEl.textContent = me.email;
    meRoleEl.textContent = me.systemRole;

    const canAdmin = (me.systemRole === "OWNER" || me.systemRole === "ADMIN" || me.isSuperadmin);
    openAdminBtn.classList.toggle("hidden", !canAdmin);
  }

  logoutBtn.onclick = async () => {
    try { await api("/api/logout", { method: "POST" }); } catch {}
    uiLoggedOut();
    statusEl.textContent = "–í—ã—à–µ–ª";
  };

  async function loadPositions() {
    const data = await api("/api/positions");
    regPosition.innerHTML = "";
    for (const p of data.positions) {
      const opt = document.createElement("option");
      opt.value = String(p.id);
      opt.textContent = p.displayName;
      regPosition.appendChild(opt);
    }
  }

  loginBtn.onclick = async () => {
    loginMsg.textContent = "";
    loginBtn.disabled = true;
    try {
      const data = await api("/api/login", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ email: loginEmail.value, password: loginPass.value })
      });
      me = data.me;
      statusEl.textContent = "–í–æ—à—ë–ª";
      uiLoggedIn();
      await initWs();
    } catch (e) {
      loginMsg.textContent = String(e.message || e);
    } finally {
      loginBtn.disabled = false;
    }
  };

  registerBtn.onclick = async () => {
    registerMsg.textContent = "";
    registerBtn.disabled = true;
    try {
      const data = await api("/api/register", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({
          displayName: regName.value,
          email: regEmail.value,
          password: regPass.value,
          positionRoleId: Number(regPosition.value)
        })
      });
      me = data.me;
      statusEl.textContent = "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω";
      uiLoggedIn();
      await initWs();
    } catch (e) {
      registerMsg.textContent = String(e.message || e);
    } finally {
      registerBtn.disabled = false;
    }
  };

  function renderReceipt(msgId) {
    const el = document.getElementById(`rc_${msgId}`);
    if (!el) return;
    const r = receiptByMessageId.get(msgId);
    if (!r || !r.total) {
      el.textContent = "‚úì";
      return;
    }
    el.textContent = `‚úì ${r.readCount}/${r.total}`;
  }

  function addMsg(m) {
    // save receipt
    if (m.read) receiptByMessageId.set(m.id, m.read);

    const div = document.createElement("div");
    div.className = "msg";

    const at = new Date(m.at).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
    const isOn = onlineUserIds.has(Number(m.fromId));

    div.innerHTML = `
      <div class="meta">
        <span>${dotHtml(isOn)}${esc(m.from)} ‚Ä¢ ${at}</span>
        <span class="receipt" id="rc_${m.id}">‚úì</span>
      </div>
      <div class="bubble">${esc(m.text)}</div>
    `;

    log.appendChild(div);
    renderReceipt(m.id);
    log.scrollTop = log.scrollHeight;
  }

  function renderChannels() {
    channelsEl.innerHTML = "";
    for (const ch of channels) {
      const el = document.createElement("div");
      el.className = "item" + (ch.id === activeChannelId ? " active" : "");
      el.textContent = "#" + ch.name + (ch.isPublic ? "" : " üîí");
      el.onclick = () => joinChannel(ch.id, ch.name);
      channelsEl.appendChild(el);
    }
  }

  async function joinChannel(id, name) {
    activeChannelId = id;
    titleEl.textContent = "#" + name;
    hintEl.textContent = "";
    log.innerHTML = "";
    receiptByMessageId = new Map();
    renderChannels();

    if (ws && ws.readyState === 1) {
      ws.send(JSON.stringify({ type: "join", channelId: id }));
    }
  }

  sendBtn.onclick = () => sendMessage();
  text.addEventListener("keydown", (e) => { if (e.key === "Enter") sendMessage(); });

  function sendMessage() {
    const t = text.value.trim();
    if (!t) return;
    if (!ws || ws.readyState !== 1 || !activeChannelId) return;
    ws.send(JSON.stringify({ type: "chat", text: t }));
    text.value = "";
    text.focus();
  }

  function sendReadIfPossible(messageId) {
    if (!ws || ws.readyState !== 1) return;
    if (!activeChannelId || !messageId) return;
    ws.send(JSON.stringify({ type: "read", channelId: activeChannelId, lastReadMessageId: messageId }));
  }

  async function initWs() {
    if (ws) { try { ws.close(); } catch {} }
    const wsProto = location.protocol === "https:" ? "wss" : "ws";
    ws = new WebSocket(`${wsProto}://${location.host}`);

    ws.addEventListener("open", () => { statusEl.textContent = "‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω"; });
    ws.addEventListener("close", () => { statusEl.textContent = "‚ö†Ô∏è WebSocket –æ—Ç–∫–ª—é—á–µ–Ω"; });

    ws.addEventListener("message", (ev) => {
      const msg = JSON.parse(ev.data);

      if (msg.type === "init") {
        me = msg.me;
        channels = msg.channels || [];
        onlineUserIds = new Set((msg.onlineUserIds || []).map(Number));

        renderChannels();
        if (channels.length) joinChannel(channels[0].id, channels[0].name);
        else {
          titleEl.textContent = "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤";
          hintEl.textContent = "–ü–æ–ø—Ä–æ—Å–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤—ã–¥–∞—Ç—å –¥–æ—Å—Ç—É–ø";
        }
        return;
      }

      if (msg.type === "presence_update") {
        const uid = Number(msg.userId);
        if (msg.online) onlineUserIds.add(uid);
        else onlineUserIds.delete(uid);

        // –æ–±–Ω–æ–≤–∏–º —Ç–æ—á–∫–∏ —É —Å–æ–æ–±—â–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
        document.querySelectorAll(".meta").forEach(() => {}); // noop
        // –ø—Ä–æ—â–µ: –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å —Ç–æ—á–∫–∏ –ø—Ä—è–º–æ –ø–æ id —Å–æ–æ–±—â. –Ω–µ –¥–µ–ª–∞–µ–º, —ç—Ç–æ MVP.
        return;
      }

      if (msg.type === "history") {
        if (msg.channelId !== activeChannelId) return;
        const messages = msg.messages || [];
        for (const m of messages) addMsg(m);

        // –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ —Å–∞–º–æ–µ –ø–æ—Å–ª–µ–¥–Ω–µ–µ
        if (messages.length) {
          const lastId = messages[messages.length - 1].id;
          sendReadIfPossible(lastId);
        }
        return;
      }

      if (msg.type === "chat") {
        if (msg.channelId !== activeChannelId) return;
        addMsg(msg.message);

        // —Ç–∞–∫ –∫–∞–∫ –º—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è –≤ –∫–∞–Ω–∞–ª–µ ‚Äî —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –ø—Ä–æ—á–∏—Ç–∞–ª–∏ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        sendReadIfPossible(msg.message.id);
        return;
      }

      if (msg.type === "read_progress") {
        if (msg.channelId !== activeChannelId) return;
        receiptByMessageId.set(Number(msg.messageId), msg.read);
        renderReceipt(Number(msg.messageId));
        return;
      }

      if (msg.type === "error") {
        alert(msg.message || msg.code || "Error");
      }
    });
  }

  // Admin UI (–∫–∞–∫ —Ä–∞–Ω—å—à–µ, –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ª–æ–≥–∏–∫–∏)
  function setAdminTab(tab) {
    for (const t of adminTabs) t.classList.toggle("active", t.dataset.adminTab === tab);
    for (const k of Object.keys(adminViews)) adminViews[k].classList.toggle("hidden", k !== tab);
  }
  adminTabs.forEach(t => t.onclick = () => setAdminTab(t.dataset.adminTab));

  openAdminBtn.onclick = async () => {
    adminCard.classList.remove("hidden");
    await refreshAdmin();
  };
  closeAdminBtn.onclick = () => adminCard.classList.add("hidden");

  function renderAccessPickers() {
    accessRoles.innerHTML = roles.map(r => `
      <label class="muted" style="display:flex; gap:8px; align-items:center; margin:6px 0;">
        <input type="checkbox" data-access-role="${r.id}" />
        ${esc(r.displayName)}
      </label>
    `).join("");

    accessUsers.innerHTML = users.map(u => `
      <label class="muted" style="display:flex; gap:8px; align-items:center; margin:6px 0;">
        <input type="checkbox" data-access-user="${u.id}" />
        ${esc(u.displayName)} <span class="muted">(${esc(u.email)})</span>
      </label>
    `).join("");
  }

  async function loadChannelAccessToUI(channelId) {
    const a = await api(`/api/admin/channels/${channelId}/access`);
    const roleSet = new Set((a.roleIds || []).map(Number));
    const userSet = new Set((a.userIds || []).map(Number));

    [...document.querySelectorAll("[data-access-role]")].forEach(chk => {
      chk.checked = roleSet.has(Number(chk.dataset.accessRole));
    });
    [...document.querySelectorAll("[data-access-user]")].forEach(chk => {
      chk.checked = userSet.has(Number(chk.dataset.accessUser));
    });

    accessMsg.textContent = "‚úÖ –î–æ—Å—Ç—É–ø –∑–∞–≥—Ä—É–∂–µ–Ω";
  }

  async function refreshAdmin() {
    const r = await api("/api/admin/roles");
    roles = r.roles || [];
    rolesList.innerHTML = roles.map(x => `<div><code>${esc(x.name)}</code> ‚Äî ${esc(x.displayName)} (id:${x.id})</div>`).join("");

    const u = await api("/api/admin/users");
    users = u.users || [];

    usersList.innerHTML = users.map(us => `
      <div class="card" style="margin-top:10px;">
        <div><b>${esc(us.displayName)}</b> <span class="pill">${esc(us.systemRole)}</span></div>
        <div class="muted">${esc(us.email)}</div>

        <div class="muted" id="userRoles_${us.id}">–†–æ–ª–∏: ‚Ä¶</div>

        <div class="row">
          <select data-user-role-select="${us.id}">
            <option value="">–í—ã–¥–∞—Ç—å —Ä–æ–ª—å‚Ä¶</option>
            ${roles.map(r => `<option value="${r.id}">${esc(r.displayName)}</option>`).join("")}
          </select>
          <button data-user-role-btn="${us.id}">–í—ã–¥–∞—Ç—å</button>
        </div>

        <div class="row" style="flex-wrap:wrap;">
          <button class="danger" data-user-role-remove-open="${us.id}">–°–Ω—è—Ç—å —Ä–æ–ª—å‚Ä¶</button>
          <select class="hidden" data-user-role-remove-select="${us.id}">
            <option value="">–í—ã–±–µ—Ä–∏ —Ä–æ–ª—å –¥–ª—è —Å–Ω—è—Ç–∏—è</option>
          </select>
          <button class="hidden danger" data-user-role-remove-btn="${us.id}">–°–Ω—è—Ç—å</button>
        </div>
      </div>
    `).join("");

    for (const us of users) {
      (async () => {
        try {
          const ur = await api(`/api/admin/users/${us.id}/roles`);
          const list = ur.roles || [];
          const label = document.getElementById(`userRoles_${us.id}`);
          label.textContent = "–†–æ–ª–∏: " + (list.map(x => x.displayName).join(", ") || "‚Äî");

          const selRemove = document.querySelector(`[data-user-role-remove-select="${us.id}"]`);
          selRemove.innerHTML = `<option value="">–í—ã–±–µ—Ä–∏ —Ä–æ–ª—å –¥–ª—è —Å–Ω—è—Ç–∏—è</option>` + list.map(x => `<option value="${x.id}">${esc(x.displayName)}</option>`).join("");
        } catch {}
      })();

      const btnAdd = document.querySelector(`[data-user-role-btn="${us.id}"]`);
      const selAdd = document.querySelector(`[data-user-role-select="${us.id}"]`);
      btnAdd.onclick = async () => {
        const roleId = Number(selAdd.value || 0);
        if (!roleId) return;
        await api(`/api/admin/users/${us.id}/roles`, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ roleId })
        });
        await refreshAdmin();
      };

      const openRemove = document.querySelector(`[data-user-role-remove-open="${us.id}"]`);
      const selRemove = document.querySelector(`[data-user-role-remove-select="${us.id}"]`);
      const btnRemove = document.querySelector(`[data-user-role-remove-btn="${us.id}"]`);
      openRemove.onclick = () => {
        selRemove.classList.toggle("hidden");
        btnRemove.classList.toggle("hidden");
      };
      btnRemove.onclick = async () => {
        const roleId = Number(selRemove.value || 0);
        if (!roleId) return;
        await api(`/api/admin/users/${us.id}/roles/${roleId}`, { method: "DELETE" });
        await refreshAdmin();
      };
    }

    const ch = await api("/api/admin/channels");
    adminAllChannels = ch.channels || [];
    accessChannel.innerHTML = adminAllChannels.map(c =>
      `<option value="${c.id}">#${esc(c.name)}${c.isPublic ? "" : " üîí"}</option>`
    ).join("");

    renderAccessPickers();

    if (adminAllChannels.length) {
      await loadChannelAccessToUI(Number(accessChannel.value));
    }

    try {
      const a = await api("/api/audit");
      auditList.innerHTML = (a.logs || []).map(l => `
        <div class="card" style="margin-top:10px;">
          <div><b>${esc(l.action)}</b> <span class="muted">${esc(new Date(l.at).toLocaleString())}</span></div>
          <div class="muted">actor: ${esc(l.actor.displayName)} (${esc(l.actor.email)})</div>
          <div class="muted"><code>${esc(JSON.stringify(l.meta))}</code></div>
        </div>
      `).join("");
    } catch {
      auditList.innerHTML = `<div class="muted">–ê—É–¥–∏—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ OWNER/SUPERADMIN</div>`;
    }
  }

  createRoleBtn.onclick = async () => {
    createRoleBtn.disabled = true;
    try {
      await api("/api/admin/roles", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ name: newRoleName.value, displayName: newRoleDisplay.value })
      });
      newRoleName.value = "";
      newRoleDisplay.value = "";
      await refreshAdmin();
    } catch (e) {
      alert(String(e.message || e));
    } finally {
      createRoleBtn.disabled = false;
    }
  };

  createChannelBtn.onclick = async () => {
    createChannelBtn.disabled = true;
    try {
      await api("/api/admin/channels", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({
          name: newChannelName.value,
          isPublic: newChannelPublic.value === "true"
        })
      });
      newChannelName.value = "";
      await refreshAdmin();
      setTimeout(() => location.reload(), 500);
    } catch (e) {
      alert(String(e.message || e));
    } finally {
      createChannelBtn.disabled = false;
    }
  };

  loadAccessBtn.onclick = async () => {
    accessMsg.textContent = "";
    try {
      await loadChannelAccessToUI(Number(accessChannel.value));
    } catch (e) {
      accessMsg.textContent = "‚ùå " + String(e.message || e);
    }
  };

  accessChannel.onchange = async () => {
    accessMsg.textContent = "";
    try {
      await loadChannelAccessToUI(Number(accessChannel.value));
    } catch {}
  };

  saveAccessBtn.onclick = async () => {
    accessMsg.textContent = "";
    saveAccessBtn.disabled = true;
    try {
      const channelId = Number(accessChannel.value || 0);
      const roleIds = [...document.querySelectorAll("[data-access-role]")].filter(x => x.checked).map(x => Number(x.dataset.accessRole));
      const userIds = [...document.querySelectorAll("[data-access-user]")].filter(x => x.checked).map(x => Number(x.dataset.accessUser));

      await api(`/api/admin/channels/${channelId}/access`, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ roleIds, userIds })
      });

      accessMsg.textContent = "‚úÖ –î–æ—Å—Ç—É–ø —Å–æ—Ö—Ä–∞–Ω—ë–Ω";
      setTimeout(() => location.reload(), 600);
    } catch (e) {
      accessMsg.textContent = "‚ùå " + String(e.message || e);
    } finally {
      saveAccessBtn.disabled = false;
    }
  };

  // Boot
  (async () => {
    try {
      await loadPositions();
      const meResp = await api("/api/me");
      me = meResp.me;
      statusEl.textContent = "–°–µ—Å—Å–∏—è –∞–∫—Ç–∏–≤–Ω–∞";
      uiLoggedIn();
      await initWs();
    } catch {
      statusEl.textContent = "–ù—É–∂–Ω–æ –≤–æ–π—Ç–∏";
      uiLoggedOut();
      setAuthMode("login");
    }
  })();
</script>
</body>
</html>
