<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Corp Chat Template</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; background:#0b1220; color:#e6edf3; }
    .app { display:flex; height:100vh; }
    .side { width:320px; padding:12px; border-right:1px solid #1f2a44; background:#0a1020; box-sizing:border-box; overflow:auto; }
    .main { flex:1; display:flex; flex-direction:column; padding:12px; box-sizing:border-box; }
    .card { background:#111a2e; border:1px solid #1f2a44; border-radius:12px; padding:10px; }
    .row { display:flex; gap:10px; margin-top:10px; }
    input, select, button, textarea { border-radius:10px; border:1px solid #2a3a63; background:#0b1220; color:#e6edf3; padding:10px; }
    input, select, textarea { width:100%; box-sizing:border-box; }
    button { cursor:pointer; white-space:nowrap; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .muted { opacity:.75; font-size:12px; }
    .list { margin-top:10px; display:flex; flex-direction:column; gap:6px; }
    .item { padding:8px 10px; border-radius:10px; border:1px solid #1f2a44; background:#0f172a; cursor:pointer; user-select:none; }
    .item:hover { filter:brightness(1.08); }
    .item.active { outline:2px solid #1f6feb; background:#0b1b3a; }

    #log { flex:1; overflow:auto; padding:12px; background:#0f172a; border-radius:12px; border:1px solid #1f2a44; margin-top:10px; }
    .msg { margin:10px 0; }
    .meta { opacity:.75; font-size:12px; display:flex; justify-content:space-between; gap:10px; }
    .bubble { display:inline-block; padding:10px 12px; border-radius:12px; background:#1b243b; white-space:pre-wrap; max-width:100%; }

    .tabs { display:flex; gap:8px; margin-top:10px; }
    .tab { padding:8px 10px; border-radius:10px; border:1px solid #1f2a44; background:#0f172a; cursor:pointer; user-select:none; }
    .tab.active { outline:2px solid #1f6feb; background:#0b1b3a; }
    .hidden { display:none !important; }

    .grid2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .hr { height:1px; background:#1f2a44; margin:10px 0; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; font-size:12px; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #2a3a63; background:#0b1220; font-size:12px; opacity:.9; }
  </style>
</head>
<body>
<div class="app">
  <div class="side">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <div>
          <div><b id="brand">Corp Chat</b></div>
          <div class="muted" id="status">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏‚Ä¶</div>
        </div>
        <button id="logoutBtn" class="hidden">–í—ã–π—Ç–∏</button>
      </div>

      <!-- Auth -->
      <div id="authBox" class="row" style="flex-direction:column;">
        <div class="tabs">
          <div id="tabLogin" class="tab active">–í—Ö–æ–¥</div>
          <div id="tabRegister" class="tab">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
        </div>

        <div id="loginForm">
          <div class="row" style="margin-top:0;">
            <input id="loginEmail" placeholder="Email" />
          </div>
          <div class="row">
            <input id="loginPass" placeholder="–ü–∞—Ä–æ–ª—å" type="password" />
          </div>
          <div class="row">
            <button id="loginBtn">–í–æ–π—Ç–∏</button>
          </div>
          <div class="muted" id="loginMsg"></div>
        </div>

        <div id="registerForm" class="hidden">
          <div class="row" style="margin-top:0;">
            <input id="regName" placeholder="–ò–º—è (–∫–∞–∫ –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ –≤ —á–∞—Ç–µ)" />
          </div>
          <div class="row">
            <input id="regEmail" placeholder="Email" />
          </div>
          <div class="row">
            <input id="regPass" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω 6 —Å–∏–º–≤–æ–ª–æ–≤)" type="password" />
          </div>
          <div class="row">
            <select id="regPosition"></select>
          </div>
          <div class="row">
            <button id="registerBtn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
          </div>
          <div class="muted" id="registerMsg"></div>
        </div>
      </div>

      <!-- User info -->
      <div id="meBox" class="hidden" style="margin-top:10px;">
        <div><b id="meName"></b> <span class="pill" id="meRole"></span></div>
        <div class="muted" id="meEmail"></div>
      </div>
    </div>

    <!-- Channels -->
    <div id="channelsCard" class="card hidden" style="margin-top:10px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <b>–ö–∞–Ω–∞–ª—ã</b>
        <button id="openAdminBtn" class="hidden">–ê–¥–º–∏–Ω–∫–∞</button>
      </div>
      <div class="list" id="channels"></div>
      <div class="muted">–í —Å–ø–∏—Å–∫–µ —Ç–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ–±–µ –∫–∞–Ω–∞–ª—ã</div>
    </div>

    <!-- Admin -->
    <div id="adminCard" class="card hidden" style="margin-top:10px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <b>–ê–¥–º–∏–Ω–∫–∞</b>
        <button id="closeAdminBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>

      <div class="tabs">
        <div class="tab active" data-admin-tab="roles">–†–æ–ª–∏</div>
        <div class="tab" data-admin-tab="users">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
        <div class="tab" data-admin-tab="channels">–ö–∞–Ω–∞–ª—ã</div>
        <div class="tab" data-admin-tab="audit">–ê—É–¥–∏—Ç</div>
      </div>

      <div id="adminRoles">
        <div class="muted">–ö–∞—Å—Ç–æ–º–Ω—ã–µ —Ä–æ–ª–∏ (–¥–æ–ª–∂–Ω–æ—Å—Ç–∏). –í—ã–¥–∞–≤–∞–π –ª—é–¥—è–º —Ä–æ–ª–∏, –ø–æ—Ç–æ–º –ø—Ä–∏–≤—è–∑—ã–≤–∞–π –∏—Ö –∫ –∫–∞–Ω–∞–ª–∞–º.</div>
        <div class="row">
          <input id="newRoleName" placeholder="role-slug (–Ω–∞–ø—Ä–∏–º–µ—Ä manager-2)" />
        </div>
        <div class="row">
          <input id="newRoleDisplay" placeholder="–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä –ú–µ–Ω–µ–¥–∂–µ—Ä)" />
          <button id="createRoleBtn">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
        <div class="hr"></div>
        <div id="rolesList" class="muted"></div>
      </div>

      <div id="adminUsers" class="hidden">
        <div class="muted">–ù–∞–∑–Ω–∞—á–∞–π –ª—é–¥—è–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ —Ä–æ–ª–∏.</div>
        <div class="hr"></div>
        <div id="usersList"></div>
      </div>

      <div id="adminChannels" class="hidden">
        <div class="muted">–°–æ–∑–¥–∞–π –∫–∞–Ω–∞–ª –∏ –∑–∞–¥–∞–π –¥–æ—Å—Ç—É–ø —Ä–æ–ª—è–º–∏ –∏/–∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –ª—é–¥—å–º–∏. –ü—É–±–ª–∏—á–Ω—ã–π –∫–∞–Ω–∞–ª –≤–∏–¥—è—Ç –≤—Å–µ.</div>
        <div class="row">
          <input id="newChannelName" placeholder="channel-name" />
        </div>
        <div class="row">
          <select id="newChannelPublic">
            <option value="true">–ü—É–±–ª–∏—á–Ω—ã–π (–≤—Å–µ–º)</option>
            <option value="false">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π (–ø–æ –¥–æ—Å—Ç—É–ø—É)</option>
          </select>
          <button id="createChannelBtn">–°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª</button>
        </div>
        <div class="hr"></div>
        <div class="muted">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ—Å—Ç—É–ø–∞: –≤—ã–±–µ—Ä–∏ –∫–∞–Ω–∞–ª, —Ä–æ–ª–∏ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.</div>
        <div class="row">
          <select id="accessChannel"></select>
        </div>
        <div class="grid2">
          <div>
            <div class="muted">–†–æ–ª–∏ —Å –¥–æ—Å—Ç—É–ø–æ–º</div>
            <div id="accessRoles"></div>
          </div>
          <div>
            <div class="muted">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –¥–æ—Å—Ç—É–ø–æ–º</div>
            <div id="accessUsers"></div>
          </div>
        </div>
        <div class="row">
          <button id="saveAccessBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–æ—Å—Ç—É–ø</button>
        </div>
        <div class="muted" id="accessMsg"></div>
      </div>

      <div id="adminAudit" class="hidden">
        <div class="muted">–ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π (OWNER/SUPERADMIN). –ü—Ä–æ—Å–º–æ—Ç—Ä DM —á–µ—Ä–µ–∑ –∞—É–¥–∏—Ç –¥–æ–±–∞–≤–∏–º —Å–ª–µ–¥—É—é—â–∏–º —à–∞–≥–æ–º.</div>
        <div class="hr"></div>
        <div id="auditList" class="muted"></div>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="card">
      <div><b id="title">‚Äî</b></div>
      <div class="muted" id="hint">–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏/–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è</div>
    </div>

    <div id="log"></div>

    <div class="row">
      <input id="text" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶" maxlength="2000" disabled />
      <button id="send" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<script>
  // Elements
  const statusEl = document.getElementById("status");
  const authBox = document.getElementById("authBox");
  const meBox = document.getElementById("meBox");
  const meNameEl = document.getElementById("meName");
  const meEmailEl = document.getElementById("meEmail");
  const meRoleEl = document.getElementById("meRole");

  const logoutBtn = document.getElementById("logoutBtn");

  const tabLogin = document.getElementById("tabLogin");
  const tabRegister = document.getElementById("tabRegister");
  const loginForm = document.getElementById("loginForm");
  const registerForm = document.getElementById("registerForm");

  const loginEmail = document.getElementById("loginEmail");
  const loginPass = document.getElementById("loginPass");
  const loginBtn = document.getElementById("loginBtn");
  const loginMsg = document.getElementById("loginMsg");

  const regName = document.getElementById("regName");
  const regEmail = document.getElementById("regEmail");
  const regPass = document.getElementById("regPass");
  const regPosition = document.getElementById("regPosition");
  const registerBtn = document.getElementById("registerBtn");
  const registerMsg = document.getElementById("registerMsg");

  const channelsCard = document.getElementById("channelsCard");
  const channelsEl = document.getElementById("channels");
  const titleEl = document.getElementById("title");
  const hintEl = document.getElementById("hint");

  const log = document.getElementById("log");
  const text = document.getElementById("text");
  const sendBtn = document.getElementById("send");

  const openAdminBtn = document.getElementById("openAdminBtn");
  const adminCard = document.getElementById("adminCard");
  const closeAdminBtn = document.getElementById("closeAdminBtn");

  // Admin elements
  const rolesList = document.getElementById("rolesList");
  const usersList = document.getElementById("usersList");
  const auditList = document.getElementById("auditList");

  const newRoleName = document.getElementById("newRoleName");
  const newRoleDisplay = document.getElementById("newRoleDisplay");
  const createRoleBtn = document.getElementById("createRoleBtn");

  const newChannelName = document.getElementById("newChannelName");
  const newChannelPublic = document.getElementById("newChannelPublic");
  const createChannelBtn = document.getElementById("createChannelBtn");

  const accessChannel = document.getElementById("accessChannel");
  const accessRoles = document.getElementById("accessRoles");
  const accessUsers = document.getElementById("accessUsers");
  const saveAccessBtn = document.getElementById("saveAccessBtn");
  const accessMsg = document.getElementById("accessMsg");

  const adminTabs = [...document.querySelectorAll("[data-admin-tab]")];
  const adminViews = {
    roles: document.getElementById("adminRoles"),
    users: document.getElementById("adminUsers"),
    channels: document.getElementById("adminChannels"),
    audit: document.getElementById("adminAudit"),
  };

  // State
  let me = null;
  let ws = null;
  let channels = []; // [{id,name,isPublic}]
  let activeChannelId = null;
  let activeChannelName = "";
  let roles = []; // admin list
  let users = []; // admin list

  function esc(s) {
    return String(s || "").replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
  }

  async function api(path, opts) {
    const res = await fetch(path, { credentials: "include", ...opts });
    const data = await res.json().catch(() => ({}));
    if (!res.ok || data.ok === false) {
      throw new Error(data.message || data.code || "Request failed");
    }
    return data;
  }

  function setAuthMode(mode) {
    if (mode === "login") {
      tabLogin.classList.add("active");
      tabRegister.classList.remove("active");
      loginForm.classList.remove("hidden");
      registerForm.classList.add("hidden");
    } else {
      tabRegister.classList.add("active");
      tabLogin.classList.remove("active");
      registerForm.classList.remove("hidden");
      loginForm.classList.add("hidden");
    }
  }

  tabLogin.onclick = () => setAuthMode("login");
  tabRegister.onclick = () => setAuthMode("register");

  function uiLoggedOut() {
    me = null;
    authBox.classList.remove("hidden");
    meBox.classList.add("hidden");
    logoutBtn.classList.add("hidden");
    channelsCard.classList.add("hidden");
    adminCard.classList.add("hidden");
    openAdminBtn.classList.add("hidden");
    titleEl.textContent = "‚Äî";
    hintEl.textContent = "–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏/–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è";
    text.disabled = true;
    sendBtn.disabled = true;
    log.innerHTML = "";
    if (ws) { try { ws.close(); } catch {} }
    ws = null;
  }

  function uiLoggedIn() {
    authBox.classList.add("hidden");
    meBox.classList.remove("hidden");
    logoutBtn.classList.remove("hidden");
    channelsCard.classList.remove("hidden");
    hintEl.textContent = "–í—ã–±–µ—Ä–∏ –∫–∞–Ω–∞–ª —Å–ª–µ–≤–∞";
    text.disabled = false;
    sendBtn.disabled = false;

    meNameEl.textContent = me.displayName;
    meEmailEl.textContent = me.email;
    meRoleEl.textContent = me.systemRole;

    const canAdmin = (me.systemRole === "OWNER" || me.systemRole === "ADMIN" || me.isSuperadmin);
    openAdminBtn.classList.toggle("hidden", !canAdmin);
  }

  logoutBtn.onclick = async () => {
    try { await api("/api/logout", { method: "POST" }); } catch {}
    uiLoggedOut();
    statusEl.textContent = "–í—ã—à–µ–ª";
  };

  async function loadPositions() {
    const data = await api("/api/positions");
    regPosition.innerHTML = "";
    for (const p of data.positions) {
      const opt = document.createElement("option");
      opt.value = String(p.id);
      opt.textContent = p.displayName;
      regPosition.appendChild(opt);
    }
  }

  loginBtn.onclick = async () => {
    loginMsg.textContent = "";
    loginBtn.disabled = true;
    try {
      const data = await api("/api/login", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ email: loginEmail.value, password: loginPass.value })
      });
      me = data.me;
      statusEl.textContent = "–í–æ—à—ë–ª";
      uiLoggedIn();
      await initWs();
    } catch (e) {
      loginMsg.textContent = String(e.message || e);
    } finally {
      loginBtn.disabled = false;
    }
  };

  registerBtn.onclick = async () => {
    registerMsg.textContent = "";
    registerBtn.disabled = true;
    try {
      const data = await api("/api/register", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({
          displayName: regName.value,
          email: regEmail.value,
          password: regPass.value,
          positionRoleId: Number(regPosition.value)
        })
      });
      me = data.me;
      statusEl.textContent = "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω";
      uiLoggedIn();
      await initWs();
    } catch (e) {
      registerMsg.textContent = String(e.message || e);
    } finally {
      registerBtn.disabled = false;
    }
  };

  function addMsg(m) {
    const div = document.createElement("div");
    div.className = "msg";
    const at = new Date(m.at).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
    div.innerHTML = `
      <div class="meta"><span>${esc(m.from)} ‚Ä¢ ${at}</span></div>
      <div class="bubble">${esc(m.text)}</div>
    `;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
  }

  function renderChannels() {
    channelsEl.innerHTML = "";
    for (const ch of channels) {
      const el = document.createElement("div");
      el.className = "item" + (ch.id === activeChannelId ? " active" : "");
      el.textContent = "#" + ch.name + (ch.isPublic ? "" : " üîí");
      el.onclick = () => joinChannel(ch.id, ch.name);
      channelsEl.appendChild(el);
    }
  }

  async function joinChannel(id, name) {
    activeChannelId = id;
    activeChannelName = name;
    titleEl.textContent = "#" + name;
    hintEl.textContent = "";
    log.innerHTML = "";
    renderChannels();
    if (ws && ws.readyState === 1) {
      ws.send(JSON.stringify({ type: "join", channelId: id }));
    }
  }

  sendBtn.onclick = () => sendMessage();
  text.addEventListener("keydown", (e) => { if (e.key === "Enter") sendMessage(); });

  function sendMessage() {
    const t = text.value.trim();
    if (!t) return;
    if (!ws || ws.readyState !== 1 || !activeChannelId) return;
    ws.send(JSON.stringify({ type: "chat", text: t }));
    text.value = "";
    text.focus();
  }

  async function initWs() {
    if (ws) { try { ws.close(); } catch {} }
    const wsProto = location.protocol === "https:" ? "wss" : "ws";
    ws = new WebSocket(`${wsProto}://${location.host}`);

    ws.addEventListener("open", () => {
      statusEl.textContent = "‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω";
    });

    ws.addEventListener("close", () => {
      statusEl.textContent = "‚ö†Ô∏è WebSocket –æ—Ç–∫–ª—é—á–µ–Ω";
    });

    ws.addEventListener("message", (ev) => {
      const msg = JSON.parse(ev.data);

      if (msg.type === "init") {
        me = msg.me;
        channels = msg.channels || [];
        renderChannels();

        // auto join first channel
        if (channels.length) {
          joinChannel(channels[0].id, channels[0].name);
        } else {
          titleEl.textContent = "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤";
          hintEl.textContent = "–ü–æ–ø—Ä–æ—Å–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤—ã–¥–∞—Ç—å –¥–æ—Å—Ç—É–ø";
        }
        return;
      }

      if (msg.type === "joined") {
        return;
      }

      if (msg.type === "history") {
        if (msg.channelId !== activeChannelId) return;
        for (const m of (msg.messages || [])) addMsg(m);
        return;
      }

      if (msg.type === "chat") {
        if (msg.channelId !== activeChannelId) return;
        addMsg(msg.message);
        return;
      }

      if (msg.type === "error") {
        alert(msg.message || msg.code || "Error");
        return;
      }
    });
  }

  // Admin UI
  function setAdminTab(tab) {
    for (const t of adminTabs) {
      t.classList.toggle("active", t.dataset.adminTab === tab);
    }
    for (const k of Object.keys(adminViews)) {
      adminViews[k].classList.toggle("hidden", k !== tab);
    }
  }
  adminTabs.forEach(t => t.onclick = () => setAdminTab(t.dataset.adminTab));

  openAdminBtn.onclick = async () => {
    adminCard.classList.remove("hidden");
    await refreshAdmin();
  };
  closeAdminBtn.onclick = () => adminCard.classList.add("hidden");

  async function refreshAdmin() {
    // roles
    const r = await api("/api/admin/roles");
    roles = r.roles || [];
    rolesList.innerHTML = roles.map(x => `<div><code>${esc(x.name)}</code> ‚Äî ${esc(x.displayName)} (id:${x.id})</div>`).join("");

    // users
    const u = await api("/api/admin/users");
    users = u.users || [];
    usersList.innerHTML = users.map(us => `
      <div class="card" style="margin-top:10px;">
        <div><b>${esc(us.displayName)}</b> <span class="pill">${esc(us.systemRole)}</span></div>
        <div class="muted">${esc(us.email)}</div>
        <div class="row">
          <select data-user-role-select="${us.id}">
            <option value="">–í—ã–¥–∞—Ç—å —Ä–æ–ª—å‚Ä¶</option>
            ${roles.map(r => `<option value="${r.id}">${esc(r.displayName)}</option>`).join("")}
          </select>
          <button data-user-role-btn="${us.id}">–í—ã–¥–∞—Ç—å</button>
        </div>
      </div>
    `).join("");

    for (const us of users) {
      const btn = document.querySelector(`[data-user-role-btn="${us.id}"]`);
      const sel = document.querySelector(`[data-user-role-select="${us.id}"]`);
      btn.onclick = async () => {
        const roleId = Number(sel.value || 0);
        if (!roleId) return;
        await api(`/api/admin/users/${us.id}/roles`, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ roleId })
        });
        alert("–†–æ–ª—å –≤—ã–¥–∞–Ω–∞");
      };
    }

    // channels list for access
    const ch = await api("/api/channels");
    // NOTE: /api/channels returns only accessible channels for current admin
    // For OWNER/SUPERADMIN it will be all channels.
    const list = ch.channels || [];
    accessChannel.innerHTML = list.map(c => `<option value="${c.id}">#${esc(c.name)}${c.isPublic ? "" : " üîí"}</option>`).join("");

    renderAccessPickers();

    // audit (owner only)
    try {
      const a = await api("/api/audit");
      auditList.innerHTML = (a.logs || []).map(l => `
        <div class="card" style="margin-top:10px;">
          <div><b>${esc(l.action)}</b> <span class="muted">${esc(new Date(l.at).toLocaleString())}</span></div>
          <div class="muted">actor: ${esc(l.actor.displayName)} (${esc(l.actor.email)})</div>
          <div class="muted"><code>${esc(JSON.stringify(l.meta))}</code></div>
        </div>
      `).join("");
    } catch {
      auditList.innerHTML = `<div class="muted">–ê—É–¥–∏—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ OWNER/SUPERADMIN</div>`;
    }
  }

  function renderAccessPickers() {
    accessRoles.innerHTML = roles.map(r => `
      <label class="muted" style="display:flex; gap:8px; align-items:center; margin:6px 0;">
        <input type="checkbox" data-access-role="${r.id}" />
        ${esc(r.displayName)}
      </label>
    `).join("");

    accessUsers.innerHTML = users.map(u => `
      <label class="muted" style="display:flex; gap:8px; align-items:center; margin:6px 0;">
        <input type="checkbox" data-access-user="${u.id}" />
        ${esc(u.displayName)} <span class="muted">(${esc(u.email)})</span>
      </label>
    `).join("");
  }

  createRoleBtn.onclick = async () => {
    createRoleBtn.disabled = true;
    try {
      await api("/api/admin/roles", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ name: newRoleName.value, displayName: newRoleDisplay.value })
      });
      newRoleName.value = "";
      newRoleDisplay.value = "";
      await refreshAdmin();
      alert("–†–æ–ª—å —Å–æ–∑–¥–∞–Ω–∞");
    } catch (e) {
      alert(String(e.message || e));
    } finally {
      createRoleBtn.disabled = false;
    }
  };

  createChannelBtn.onclick = async () => {
    createChannelBtn.disabled = true;
    try {
      await api("/api/admin/channels", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({
          name: newChannelName.value,
          isPublic: newChannelPublic.value === "true"
        })
      });
      newChannelName.value = "";
      await refreshAdmin();
      alert("–ö–∞–Ω–∞–ª —Å–æ–∑–¥–∞–Ω");
    } catch (e) {
      alert(String(e.message || e));
    } finally {
      createChannelBtn.disabled = false;
    }
  };

  saveAccessBtn.onclick = async () => {
    accessMsg.textContent = "";
    saveAccessBtn.disabled = true;
    try {
      const channelId = Number(accessChannel.value || 0);
      const roleIds = [...document.querySelectorAll("[data-access-role]")].filter(x => x.checked).map(x => Number(x.dataset.accessRole));
      const userIds = [...document.querySelectorAll("[data-access-user]")].filter(x => x.checked).map(x => Number(x.dataset.accessUser));

      await api(`/api/admin/channels/${channelId}/access`, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ roleIds, userIds })
      });
      accessMsg.textContent = "‚úÖ –î–æ—Å—Ç—É–ø —Å–æ—Ö—Ä–∞–Ω—ë–Ω";
      // after access change, refresh ws init by reloading page (fast MVP)
      setTimeout(() => location.reload(), 600);
    } catch (e) {
      accessMsg.textContent = "‚ùå " + String(e.message || e);
    } finally {
      saveAccessBtn.disabled = false;
    }
  };

  // Boot
  (async () => {
    try {
      await loadPositions();
      // check session
      const meResp = await api("/api/me");
      me = meResp.me;
      statusEl.textContent = "–°–µ—Å—Å–∏—è –∞–∫—Ç–∏–≤–Ω–∞";
      uiLoggedIn();
      await initWs();
    } catch {
      statusEl.textContent = "–ù—É–∂–Ω–æ –≤–æ–π—Ç–∏";
      uiLoggedOut();
      setAuthMode("login");
    }
  })();
</script>
</body>
</html>
