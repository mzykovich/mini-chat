<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Corp Chat Template</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; background:#0b1220; color:#e6edf3; }
    .app { display:flex; height:100vh; }
    .side { width:360px; padding:12px; border-right:1px solid #1f2a44; background:#0a1020; box-sizing:border-box; overflow:auto; }
    .main { flex:1; display:flex; flex-direction:column; padding:12px; box-sizing:border-box; }
    .card { background:#111a2e; border:1px solid #1f2a44; border-radius:12px; padding:10px; }
    .row { display:flex; gap:10px; margin-top:10px; }
    input, select, button { border-radius:10px; border:1px solid #2a3a63; background:#0b1220; color:#e6edf3; padding:10px; }
    input, select { width:100%; box-sizing:border-box; }
    button { cursor:pointer; white-space:nowrap; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .muted { opacity:.75; font-size:12px; }
    .list { margin-top:10px; display:flex; flex-direction:column; gap:6px; }

    .item {
      padding:8px 10px; border-radius:10px; border:1px solid #1f2a44; background:#0f172a;
      cursor:pointer; user-select:none;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .item:hover { filter:brightness(1.08); }
    .item.active { outline:2px solid #1f6feb; background:#0b1b3a; }

    .leftline { display:flex; align-items:center; gap:8px; min-width:0; }
    .truncate { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .badge {
      display:inline-flex; align-items:center; justify-content:center;
      min-width:22px; height:18px; padding:0 6px;
      border-radius:999px; border:1px solid #2a3a63;
      background:#0b1220; font-size:12px; opacity:.95;
    }

    #log { flex:1; overflow:auto; padding:12px; background:#0f172a; border-radius:12px; border:1px solid #1f2a44; margin-top:10px; }
    .msg { margin:10px 0; }
    .meta { opacity:.75; font-size:12px; display:flex; justify-content:space-between; gap:10px; align-items:center; }
    .bubble { display:inline-block; padding:10px 12px; border-radius:12px; background:#1b243b; white-space:pre-wrap; max-width:100%; }
    .receipt { opacity:.8; font-size:12px; margin-left:10px; min-width:56px; text-align:right; }
    .receipt.dim { opacity:.35; }

    .dot { width:8px; height:8px; border-radius:999px; display:inline-block; vertical-align:middle; border:1px solid #2a3a63; }
    .dot.on { background:#22c55e; }
    .dot.off { background:#0b1220; }

    .tabs { display:flex; gap:8px; margin-top:10px; overflow-x:auto; padding-bottom:6px; scrollbar-width: thin; }
    .tab { flex:0 0 auto; padding:8px 10px; border-radius:10px; border:1px solid #1f2a44; background:#0f172a; cursor:pointer; user-select:none; }
    .tab.active { outline:2px solid #1f6feb; background:#0b1b3a; }
    .hidden { display:none !important; }
    .hr { height:1px; background:#1f2a44; margin:10px 0; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; font-size:12px; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #2a3a63; background:#0b1220; font-size:12px; opacity:.9; }
    .danger { border-color:#7f1d1d !important; }

    #adminCard { max-height: 72vh; overflow:auto; }
    .small { font-size: 12px; opacity:.85; }
  </style>
</head>
<body>
<div class="app">
  <div class="side">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <div>
          <div><b id="brand">Corp Chat</b></div>
          <div class="muted" id="status">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏‚Ä¶</div>
        </div>
        <button id="logoutBtn" class="hidden">–í—ã–π—Ç–∏</button>
      </div>

      <div id="authBox" class="row" style="flex-direction:column;">
        <div class="tabs">
          <div id="tabLogin" class="tab active">–í—Ö–æ–¥</div>
          <div id="tabRegister" class="tab">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
        </div>

        <div id="loginForm">
          <div class="row" style="margin-top:0;">
            <input id="loginEmail" placeholder="Email" />
          </div>
          <div class="row">
            <input id="loginPass" placeholder="–ü–∞—Ä–æ–ª—å" type="password" />
          </div>
          <div class="row">
            <button id="loginBtn">–í–æ–π—Ç–∏</button>
          </div>
          <div class="muted" id="loginMsg"></div>
        </div>

        <div id="registerForm" class="hidden">
          <div class="row" style="margin-top:0;">
            <input id="regName" placeholder="–ò–º—è (–∫–∞–∫ –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ –≤ —á–∞—Ç–µ)" />
          </div>
          <div class="row">
            <input id="regEmail" placeholder="Email" />
          </div>
          <div class="row">
            <input id="regPass" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω 6 —Å–∏–º–≤–æ–ª–æ–≤)" type="password" />
          </div>
          <div class="row">
            <input id="regInvite" placeholder="–ò–Ω–≤–∞–π—Ç-–∫–æ–¥ (–æ–±—è–∑–∞—Ç–µ–ª–µ–Ω)" />
          </div>
          <div class="row">
            <select id="regPosition"></select>
          </div>
          <div class="row">
            <button id="registerBtn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
          </div>
          <div class="muted" id="registerMsg"></div>
        </div>
      </div>

      <div id="meBox" class="hidden" style="margin-top:10px;">
        <div><b id="meName"></b> <span class="pill" id="meRole"></span></div>
        <div class="muted" id="meEmail"></div>
      </div>
    </div>

    <div id="channelsCard" class="card hidden" style="margin-top:10px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <b>–ö–∞–Ω–∞–ª—ã</b>
        <button id="openAdminBtn" class="hidden">–ê–¥–º–∏–Ω–∫–∞</button>
      </div>
      <div class="list" id="channels"></div>
      <div class="muted">–í —Å–ø–∏—Å–∫–µ —Ç–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ–±–µ –∫–∞–Ω–∞–ª—ã</div>
    </div>

    <div id="dmCard" class="card hidden" style="margin-top:10px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <b>–õ–∏—á–Ω—ã–µ</b>
        <button id="newDmBtn">–ù–æ–≤—ã–π DM</button>
      </div>
      <div class="row">
        <select id="dmUserSelect" class="hidden"></select>
        <button id="dmOpenBtn" class="hidden">–û—Ç–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="list" id="dmList"></div>
      <div class="muted">DM –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —ç—Ç–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞</div>
    </div>

    <!-- –ê–¥–º–∏–Ω–∫–∞ (–∫–∞–∫ —Ä–∞–Ω—å—à–µ) -->
    <div id="adminCard" class="card hidden" style="margin-top:10px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <b>–ê–¥–º–∏–Ω–∫–∞</b>
        <button id="closeAdminBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>

      <div class="tabs">
        <div class="tab active" data-admin-tab="roles">–†–æ–ª–∏</div>
        <div class="tab" data-admin-tab="users">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
        <div class="tab" data-admin-tab="channels">–ö–∞–Ω–∞–ª—ã</div>
        <div class="tab" data-admin-tab="audit">–ê—É–¥–∏—Ç</div>
        <div class="tab" data-admin-tab="dms">DM –∞—É–¥–∏—Ç</div>
        <div class="tab" data-admin-tab="invites">–ò–Ω–≤–∞–π—Ç—ã</div>
      </div>

      <div id="adminRoles">
        <div class="muted">–ö–∞—Å—Ç–æ–º–Ω—ã–µ —Ä–æ–ª–∏ (–¥–æ–ª–∂–Ω–æ—Å—Ç–∏).</div>
        <div class="row">
          <input id="newRoleName" placeholder="role-slug (–Ω–∞–ø—Ä–∏–º–µ—Ä sales-manager)" />
        </div>
        <div class="row">
          <input id="newRoleDisplay" placeholder="–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä –ú–µ–Ω–µ–¥–∂–µ—Ä)" />
          <button id="createRoleBtn">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
        <div class="hr"></div>
        <div id="rolesList" class="muted"></div>
      </div>

      <div id="adminUsers" class="hidden">
        <div class="muted">–í—ã–¥–∞–≤–∞–π –∏ —Å–Ω–∏–º–∞–π —Ä–æ–ª–∏.</div>
        <div class="hr"></div>
        <div id="usersList"></div>
      </div>

      <div id="adminChannels" class="hidden">
        <div class="muted">–ö–∞–Ω–∞–ª—ã –∏ –¥–æ—Å—Ç—É–ø.</div>
        <div class="row">
          <input id="newChannelName" placeholder="channel-name" />
        </div>
        <div class="row">
          <select id="newChannelPublic">
            <option value="true">–ü—É–±–ª–∏—á–Ω—ã–π (–≤—Å–µ–º)</option>
            <option value="false">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π (–ø–æ –¥–æ—Å—Ç—É–ø—É)</option>
          </select>
          <button id="createChannelBtn">–°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª</button>
        </div>

        <div class="hr"></div>

        <div class="muted">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ—Å—Ç—É–ø–∞:</div>
        <div class="row">
          <select id="accessChannel"></select>
          <button id="loadAccessBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ—Å—Ç—É–ø</button>
        </div>

        <div class="row">
          <div style="flex:1">
            <div class="muted">–†–æ–ª–∏ —Å –¥–æ—Å—Ç—É–ø–æ–º</div>
            <div id="accessRoles"></div>
          </div>
          <div style="flex:1">
            <div class="muted">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –¥–æ—Å—Ç—É–ø–æ–º</div>
            <div id="accessUsers"></div>
          </div>
        </div>

        <div class="row">
          <button id="saveAccessBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–æ—Å—Ç—É–ø</button>
        </div>
        <div class="muted" id="accessMsg"></div>
      </div>

      <div id="adminAudit" class="hidden">
        <div class="muted">–ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π (OWNER/SUPERADMIN).</div>
        <div class="hr"></div>
        <div id="auditList" class="muted"></div>
      </div>

      <div id="adminDms" class="hidden">
        <div class="muted">–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (OWNER/SUPERADMIN). –ö–∞–∂–¥—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ –∞—É–¥–∏—Ç.</div>
        <div class="hr"></div>
        <div class="row">
          <select id="dmAuditSelect"></select>
          <button id="dmAuditLoadBtn">–û—Ç–∫—Ä—ã—Ç—å</button>
        </div>
        <div id="dmAuditLog" class="small"></div>
        <div class="hr"></div>
        <div id="dmAuditMessages"></div>
      </div>

      <div id="adminInvites" class="hidden">
        <div class="muted">–ò–Ω–≤–∞–π—Ç—ã –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (ADMIN/OWNER). –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –±–µ–∑ –∏–Ω–≤–∞–π—Ç–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (OWNER).</div>
        <div class="hr"></div>

        <div class="row">
          <input id="inviteMaxUses" placeholder="–ú–∞–∫—Å. –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä 1)" />
          <input id="inviteExpiresHours" placeholder="–°—Ä–æ–∫ (—á–∞—Å–æ–≤, 0 = –±–µ–∑ —Å—Ä–æ–∫–∞)" />
          <button id="inviteCreateBtn">–°–æ–∑–¥–∞—Ç—å –∏–Ω–≤–∞–π—Ç</button>
        </div>
        <div class="row" style="flex-wrap:wrap; gap:8px;">
          <button id="inviteQuick1">–ë—ã—Å—Ç—Ä—ã–π: 1 —Ä–∞–∑</button>
          <button id="inviteQuick24">–ë—ã—Å—Ç—Ä—ã–π: 1 —Ä–∞–∑ / 24—á</button>
          <button id="inviteQuick10">–ë—ã—Å—Ç—Ä—ã–π: 10 —Ä–∞–∑</button>
        </div>
        <div class="muted" id="inviteMsg"></div>

        <div class="hr"></div>
        <div id="invitesList" class="small"></div>
      </div>

    </div>
  </div>

  <div class="main">
    <div class="card">
      <div><b id="title">‚Äî</b></div>
      <div class="muted" id="hint">–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏/–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è</div>
    </div>

    <div id="log"></div>

    <div class="row">
      <input id="text" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶" maxlength="2000" disabled />
      <button id="send" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<script>
  const statusEl = document.getElementById("status");
  const authBox = document.getElementById("authBox");
  const meBox = document.getElementById("meBox");
  const meNameEl = document.getElementById("meName");
  const meEmailEl = document.getElementById("meEmail");
  const meRoleEl = document.getElementById("meRole");
  const logoutBtn = document.getElementById("logoutBtn");

  const tabLogin = document.getElementById("tabLogin");
  const tabRegister = document.getElementById("tabRegister");
  const loginForm = document.getElementById("loginForm");
  const registerForm = document.getElementById("registerForm");

  const loginEmail = document.getElementById("loginEmail");
  const loginPass = document.getElementById("loginPass");
  const loginBtn = document.getElementById("loginBtn");
  const loginMsg = document.getElementById("loginMsg");

  const regName = document.getElementById("regName");
  const regEmail = document.getElementById("regEmail");
  const regPass = document.getElementById("regPass");
  const regInvite = document.getElementById("regInvite");
  const regPosition = document.getElementById("regPosition");
  const registerBtn = document.getElementById("registerBtn");
  const registerMsg = document.getElementById("registerMsg");

  const channelsCard = document.getElementById("channelsCard");
  const channelsEl = document.getElementById("channels");

  const dmCard = document.getElementById("dmCard");
  const dmListEl = document.getElementById("dmList");
  const newDmBtn = document.getElementById("newDmBtn");
  const dmUserSelect = document.getElementById("dmUserSelect");
  const dmOpenBtn = document.getElementById("dmOpenBtn");

  const titleEl = document.getElementById("title");
  const hintEl = document.getElementById("hint");

  const log = document.getElementById("log");
  const text = document.getElementById("text");
  const sendBtn = document.getElementById("send");

  const openAdminBtn = document.getElementById("openAdminBtn");
  const adminCard = document.getElementById("adminCard");
  const closeAdminBtn = document.getElementById("closeAdminBtn");

  // admin
  const rolesList = document.getElementById("rolesList");
  const usersList = document.getElementById("usersList");
  const auditList = document.getElementById("auditList");
  const newRoleName = document.getElementById("newRoleName");
  const newRoleDisplay = document.getElementById("newRoleDisplay");
  const createRoleBtn = document.getElementById("createRoleBtn");
  const newChannelName = document.getElementById("newChannelName");
  const newChannelPublic = document.getElementById("newChannelPublic");
  const createChannelBtn = document.getElementById("createChannelBtn");
  const accessChannel = document.getElementById("accessChannel");
  const loadAccessBtn = document.getElementById("loadAccessBtn");
  const accessRoles = document.getElementById("accessRoles");
  const accessUsers = document.getElementById("accessUsers");
  const saveAccessBtn = document.getElementById("saveAccessBtn");
  const accessMsg = document.getElementById("accessMsg");

  // admin DM audit
  const dmAuditSelect = document.getElementById("dmAuditSelect");
  const dmAuditLoadBtn = document.getElementById("dmAuditLoadBtn");
  const dmAuditLog = document.getElementById("dmAuditLog");
  const dmAuditMessages = document.getElementById("dmAuditMessages");

  // admin invites
  const inviteMaxUses = document.getElementById("inviteMaxUses");
  const inviteExpiresHours = document.getElementById("inviteExpiresHours");
  const inviteCreateBtn = document.getElementById("inviteCreateBtn");
  const inviteMsg = document.getElementById("inviteMsg");
  const invitesList = document.getElementById("invitesList");
  const inviteQuick1 = document.getElementById("inviteQuick1");
  const inviteQuick24 = document.getElementById("inviteQuick24");
  const inviteQuick10 = document.getElementById("inviteQuick10");

  const adminTabs = [...document.querySelectorAll("[data-admin-tab]")];
  const adminViews = {
    roles: document.getElementById("adminRoles"),
    users: document.getElementById("adminUsers"),
    channels: document.getElementById("adminChannels"),
    audit: document.getElementById("adminAudit"),
    dms: document.getElementById("adminDms"),
    invites: document.getElementById("adminInvites"),
  };

  let me = null;
  let ws = null;

  let hasInviteParam = false;

  let channels = [];             // {id,name,isPublic,unreadCount,lastMessageId}
  let dmChats = [];              // {id,otherUser,unreadCount,lastMessageId,last...}

  let activeMode = "channel";    // channel | dm
  let activeChannelId = null;
  let activeDmChatId = null;
  let activeDmOther = null;

  let roles = [];
  let users = [];
  let adminAllChannels = [];

  // presence + receipts
  let onlineUserIds = new Set();
  // messageId -> {readCount,total}
  let receiptByMessageId = new Map();
  // messageId -> fromId (–Ω—É–∂–Ω–æ —á—Ç–æ–±—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å receipt —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–≤–æ–∏—Ö)
  let messageFromId = new Map();

  function updateHeaderStatus() {
    // –ö–∞–Ω–∞–ª: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω –≤ —Ü–µ–ª–æ–º (–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
    if (activeMode === "channel") {
      if (activeChannelId) {
        hintEl.textContent = `–æ–Ω–ª–∞–π–Ω: ${onlineUserIds.size}`;
      }
      return;
    }
    // DM: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–Ω–ª–∞–π–Ω/–æ—Ñ—Ñ–ª–∞–π–Ω —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
    if (activeMode === "dm") {
      if (activeDmOther && activeDmOther.id) {
        const isOn = onlineUserIds.has(Number(activeDmOther.id));
        hintEl.textContent = isOn ? "–≤ —Å–µ—Ç–∏" : "–Ω–µ –≤ —Å–µ—Ç–∏";
      }
      return;
    }
    // default
    // hintEl.textContent stays as is
  }

  function esc(s) {
    return String(s || "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[c]));
  }

  async function api(path, opts) {
    const res = await fetch(path, { credentials: "include", ...opts });
    const data = await res.json().catch(() => ({}));
    if (!res.ok || data.ok === false) throw new Error(data.message || data.code || "Request failed");
    return data;
  }

  function dotHtml(isOn) {
    return `<span class="dot ${isOn ? "on" : "off"}"></span>`;
  }

  function badgeHtml(n) {
    if (!n || n <= 0) return "";
    return `<span class="badge">${n > 99 ? "99+" : n}</span>`;
  }

  async function createInviteAndCopy(maxUses, expiresInHours) {
    inviteMsg.textContent = "";
    inviteCreateBtn.disabled = true;
    try {
      const resp = await api("/api/admin/invites", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ maxUses, expiresInHours })
      });
      const token = resp.invite?.token;
      if (!token) throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∏–Ω–≤–∞–π—Ç");
      const link = `${location.origin}/?invite=${token}`;

      try {
        await navigator.clipboard.writeText(link);
        inviteMsg.textContent = "‚úÖ –ò–Ω–≤–∞–π—Ç —Å–æ–∑–¥–∞–Ω –∏ —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞";
      } catch {
        inviteMsg.textContent = "‚úÖ –ò–Ω–≤–∞–π—Ç —Å–æ–∑–¥–∞–Ω. –°–∫–æ–ø–∏—Ä—É–π —Å—Å—ã–ª–∫—É: " + link;
      }

      await refreshAdmin();
    } catch (e) {
      inviteMsg.textContent = "‚ùå " + String(e.message || e);
    } finally {
      inviteCreateBtn.disabled = false;
    }
  }


  function setAuthMode(mode) {
    if (!hasInviteParam && mode === "register") {
      // —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –ø–æ –∏–Ω–≤–∞–π—Ç—É (—Å—Å—ã–ª–∫–∞ –≤–∏–¥–∞ ?invite=...)
      return;
    }
    if (mode === "login") {
      tabLogin.classList.add("active");
      tabRegister.classList.remove("active");
      loginForm.classList.remove("hidden");
      registerForm.classList.add("hidden");
    } else {
      tabRegister.classList.add("active");
      tabLogin.classList.remove("active");
      registerForm.classList.remove("hidden");
      loginForm.classList.add("hidden");
    }
  }
  tabLogin.onclick = () => setAuthMode("login");
  tabRegister.onclick = () => setAuthMode("register");

  function uiLoggedOut() {
    me = null;
    authBox.classList.remove("hidden");
    meBox.classList.add("hidden");
    logoutBtn.classList.add("hidden");
    channelsCard.classList.add("hidden");
    dmCard.classList.add("hidden");
    adminCard.classList.add("hidden");
    openAdminBtn.classList.add("hidden");

    titleEl.textContent = "‚Äî";
    hintEl.textContent = "–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏/–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è";
    text.disabled = true;
    sendBtn.disabled = true;
    log.innerHTML = "";

    onlineUserIds = new Set();
    receiptByMessageId = new Map();
    messageFromId = new Map();
    activeMode = "channel";
    activeChannelId = null;
    activeDmChatId = null;

    if (ws) { try { ws.close(); } catch {} }
    ws = null;

    // —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –ø–æ –∏–Ω–≤–∞–π—Ç—É
    tabRegister.classList.toggle("hidden", !hasInviteParam);

  }

  function uiLoggedIn() {
    authBox.classList.add("hidden");
    meBox.classList.remove("hidden");
    logoutBtn.classList.remove("hidden");
    channelsCard.classList.remove("hidden");
    dmCard.classList.remove("hidden");

    hintEl.textContent = "–í—ã–±–µ—Ä–∏ –∫–∞–Ω–∞–ª –∏–ª–∏ DM —Å–ª–µ–≤–∞";
    text.disabled = false;
    sendBtn.disabled = false;

    meNameEl.textContent = me.displayName;
    meEmailEl.textContent = me.email;
    meRoleEl.textContent = me.systemRole;

    const canAdmin = (me.systemRole === "OWNER" || me.systemRole === "ADMIN" || me.isSuperadmin);
    openAdminBtn.classList.toggle("hidden", !canAdmin);
    applyAdminTabPermissions();
  }

  function applyAdminTabPermissions() {
    const canOwnerView = (me && (me.systemRole === "OWNER" || me.isSuperadmin));
    // OWNER/SUPERADMIN: –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
    // ADMIN: –±–µ–∑ "–ê—É–¥–∏—Ç" –∏ "DM –∞—É–¥–∏—Ç"
    const hideForAdmin = new Set(["audit", "dms"]);
    for (const t of adminTabs) {
      const tab = t.dataset.adminTab;
      if (!tab) continue;
      const shouldHide = (!canOwnerView && hideForAdmin.has(tab));
      t.classList.toggle("hidden", shouldHide);
      // also hide corresponding view if needed
      if (adminViews[tab]) adminViews[tab].classList.toggle("hidden", shouldHide || !t.classList.contains("active"));
    }

    // –µ—Å–ª–∏ —Ç–µ–∫—É—â–∞—è –∞–∫—Ç–∏–≤–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∏–º –Ω–∞ roles
    const activeTabEl = adminTabs.find(t => t.classList.contains("active"));
    const activeTab = activeTabEl ? activeTabEl.dataset.adminTab : null;
    if (activeTab && !canOwnerView && hideForAdmin.has(activeTab)) {
      setAdminTab("roles");
    }
  }


  logoutBtn.onclick = async () => {
    try { await api("/api/logout", { method: "POST" }); } catch {}
    uiLoggedOut();
    statusEl.textContent = "–í—ã—à–µ–ª";
  };

  async function loadPositions() {
    const data = await api("/api/positions");
    regPosition.innerHTML = "";
    for (const p of data.positions) {
      const opt = document.createElement("option");
      opt.value = String(p.id);
      opt.textContent = p.displayName;
      regPosition.appendChild(opt);
    }
  }

  async function refreshChannels() {
    const data = await api("/api/channels");
    channels = data.channels || [];
    renderChannels();
  }

  async function refreshDmList() {
    const data = await api("/api/dm");
    dmChats = data.chats || [];
    renderDmListUI();
  }

  loginBtn.onclick = async () => {
    loginMsg.textContent = "";
    loginBtn.disabled = true;
    try {
      const data = await api("/api/login", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ email: loginEmail.value, password: loginPass.value })
      });
      me = data.me;
      statusEl.textContent = "–í–æ—à—ë–ª";
      uiLoggedIn();
      await initWs();
      await refreshChannels();
      await refreshDmList();
    } catch (e) {
      loginMsg.textContent = String(e.message || e);
    } finally {
      loginBtn.disabled = false;
    }
  };

  registerBtn.onclick = async () => {
    registerMsg.textContent = "";
    registerBtn.disabled = true;
    try {
      const data = await api("/api/register", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({
          displayName: regName.value,
          email: regEmail.value,
          password: regPass.value,
          positionRoleId: Number(regPosition.value),
          inviteToken: (document.getElementById('regInvite')?.value || '').trim()
        })
      });
      me = data.me;
      statusEl.textContent = "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω";
      uiLoggedIn();
      await initWs();
      await refreshChannels();
      await refreshDmList();
    } catch (e) {
      registerMsg.textContent = String(e.message || e);
    } finally {
      registerBtn.disabled = false;
    }
  };

  function renderReceipt(msgId) {
    const el = document.getElementById(`rc_${msgId}`);
    if (!el) return;

    // receipts –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
    const fromId = Number(messageFromId.get(msgId) || 0);
    const isMine = me && fromId === Number(me.id);
    if (!isMine) {
      el.textContent = "";
      el.classList.add("dim");
      return;
    }

    el.classList.remove("dim");

    const r = receiptByMessageId.get(msgId);
    if (!r || !r.total) {
      el.textContent = "‚úì";
      return;
    }

    // —á—Ç–æ–±—ã –Ω–µ –ø—É—Ç–∞—Ç—å: readCount –≤–∫–ª—é—á–∞–µ—Ç –∏ —Ç–µ–±—è, —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ (—Ä–µ–∞–ª—å–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–ª = —Ç—ã —Ç–æ–∂–µ)
    if (r.readCount >= r.total) {
      el.textContent = "‚úì‚úì";
    } else {
      el.textContent = `‚úì ${r.readCount}/${r.total}`;
    }
  }

  function addMsg(m) {
    messageFromId.set(m.id, Number(m.fromId));
    if (m.read) receiptByMessageId.set(m.id, m.read);

    const div = document.createElement("div");
    div.className = "msg";

    const at = new Date(m.at).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
    const isOn = onlineUserIds.has(Number(m.fromId));

    div.innerHTML = `
      <div class="meta">
        <span style="display:flex; gap:8px; align-items:center;">
          ${dotHtml(isOn)}
          <span class="truncate">${esc(m.from)} ‚Ä¢ ${at}</span>
        </span>
        <span class="receipt" id="rc_${m.id}"></span>
      </div>
      <div class="bubble">${esc(m.text)}</div>
    `;
    log.appendChild(div);
    renderReceipt(m.id);
    log.scrollTop = log.scrollHeight;
  }

  function renderChannels() {
    channelsEl.innerHTML = "";
    for (const ch of channels) {
      const active = (activeMode === "channel" && ch.id === activeChannelId);
      const el = document.createElement("div");
      el.className = "item" + (active ? " active" : "");

      const name = "#" + ch.name + (ch.isPublic ? "" : " üîí");
      const unread = badgeHtml(ch.unreadCount);

      el.innerHTML = `
        <div class="leftline">
          <span class="truncate">${esc(name)}</span>
        </div>
        ${unread}
      `;

      el.onclick = () => joinChannel(ch.id, ch.name);
      channelsEl.appendChild(el);
    }
  }

  function renderDmListUI() {
    dmListEl.innerHTML = "";
    for (const c of dmChats) {
      const isOn = onlineUserIds.has(Number(c.otherUser.id));
      const active = (activeMode === "dm" && Number(c.id) === Number(activeDmChatId));
      const el = document.createElement("div");
      el.className = "item" + (active ? " active" : "");

      const last = c.last ? ` ‚Äî ${c.last.text}` : "";
      const unread = badgeHtml(c.unreadCount);

      el.innerHTML = `
        <div class="leftline" style="min-width:0;">
          ${dotHtml(isOn)}
          <div class="truncate"><b>${esc(c.otherUser.displayName)}</b><span class="muted">${esc(last).slice(0, 40)}${(last.length>40)?"‚Ä¶":""}</span></div>
        </div>
        ${unread}
      `;
      el.onclick = () => openDmChat(c.id, c.otherUser);
      dmListEl.appendChild(el);
    }
  }

  async function joinChannel(id, name) {
    activeMode = "channel";
    activeChannelId = id;
    activeDmChatId = null;
    activeDmOther = null;

    titleEl.textContent = "#" + name;
    hintEl.textContent = "";
    updateHeaderStatus();
    updateHeaderStatus();
    log.innerHTML = "";
    receiptByMessageId = new Map();
    messageFromId = new Map();

    renderChannels();
    renderDmListUI();

    if (ws && ws.readyState === 1) {
      ws.send(JSON.stringify({ type: "join", channelId: id }));
    }
  }

  async function openDmChat(chatId, otherUser) {
    activeMode = "dm";
    activeDmChatId = Number(chatId);
    activeDmOther = otherUser || null;
    activeChannelId = null;

    titleEl.textContent = `DM: ${otherUser ? otherUser.displayName : ("#" + chatId)}`;
    hintEl.textContent = "";
    updateHeaderStatus();
    log.innerHTML = "";
    receiptByMessageId = new Map();
    messageFromId = new Map();

    renderChannels();
    renderDmListUI();

    if (ws && ws.readyState === 1) {
      ws.send(JSON.stringify({ type: "dm_join", chatId: Number(chatId) }));
    }
  }

  sendBtn.onclick = () => sendMessage();
  text.addEventListener("keydown", (e) => { if (e.key === "Enter") sendMessage(); });

  function sendReadChannelIfPossible(messageId) {
    if (!ws || ws.readyState !== 1) return;
    if (!activeChannelId || !messageId) return;
    ws.send(JSON.stringify({ type: "read", channelId: activeChannelId, lastReadMessageId: messageId }));
  }
  function sendReadDmIfPossible(messageId) {
    if (!ws || ws.readyState !== 1) return;
    if (!activeDmChatId || !messageId) return;
    ws.send(JSON.stringify({ type: "dm_read", chatId: activeDmChatId, lastReadMessageId: messageId }));
  }

  function sendMessage() {
    const t = text.value.trim();
    if (!t) return;
    if (!ws || ws.readyState !== 1) return;

    if (activeMode === "channel") {
      if (!activeChannelId) return;
      ws.send(JSON.stringify({ type: "chat", text: t }));
    } else if (activeMode === "dm") {
      if (!activeDmChatId) return;
      ws.send(JSON.stringify({ type: "dm_chat", text: t }));
    } else return;

    text.value = "";
    text.focus();
  }

  async function initWs() {
    if (ws) { try { ws.close(); } catch {} }
    const wsProto = location.protocol === "https:" ? "wss" : "ws";
    ws = new WebSocket(`${wsProto}://${location.host}`);

    ws.addEventListener("open", () => { statusEl.textContent = "‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω"; });
    ws.addEventListener("close", () => { statusEl.textContent = "‚ö†Ô∏è WebSocket –æ—Ç–∫–ª—é—á–µ–Ω"; });

    ws.addEventListener("message", async (ev) => {
      const msg = JSON.parse(ev.data);

      if (msg.type === "init") {
        me = msg.me;
        channels = msg.channels || [];
        onlineUserIds = new Set((msg.onlineUserIds || []).map(Number));
        renderChannels();

        if (channels.length) { joinChannel(channels[0].id, channels[0].name); updateHeaderStatus(); }
        else {
          titleEl.textContent = "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤";
          hintEl.textContent = "–ü–æ–ø—Ä–æ—Å–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤—ã–¥–∞—Ç—å –¥–æ—Å—Ç—É–ø";
        }

        await refreshDmList();
        return;
      }

      if (msg.type === "presence_update") {
        const uid = Number(msg.userId);
        if (msg.online) onlineUserIds.add(uid);
        else onlineUserIds.delete(uid);

        // –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º —Å–ø–∏—Å–∫–∏ —á—Ç–æ–±—ã —Ç–æ—á–∫–∏ online –æ–±–Ω–æ–≤–∏–ª–∏—Å—å
        renderDmListUI();
        updateHeaderStatus();
        // –≤ –ª–æ–≥–∞—Ö —Ç–æ—á–∫–∞ –æ–±–Ω–æ–≤–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π ‚Äî –ø–æ–∫–∞ –æ–∫
        return;
      }

      if (msg.type === "refresh_lists") {
        await refreshChannels();
        await refreshDmList();
        return;
      }

      if (msg.type === "channel_notice") {
        await refreshChannels();
        return;
      }

      if (msg.type === "dm_notice") {
        await refreshDmList();
        return;
      }

      if (msg.type === "history") {
        if (activeMode !== "channel") return;
        if (msg.channelId !== activeChannelId) return;

        const messages = msg.messages || [];
        for (const m of messages) addMsg(m);

        if (messages.length) sendReadChannelIfPossible(messages[messages.length - 1].id);
        await refreshChannels();
        return;
      }

      if (msg.type === "chat") {
        if (activeMode !== "channel") return;
        if (msg.channelId !== activeChannelId) return;

        addMsg(msg.message);
        sendReadChannelIfPossible(msg.message.id);
        await refreshChannels();
        return;
      }

      // –ù–û–í–û–ï: –±–∞—Ç—á –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ receipts –¥–ª—è —Ö–≤–æ—Å—Ç–∞
      if (msg.type === "read_progress_batch") {
        if (activeMode !== "channel") return;
        if (msg.channelId !== activeChannelId) return;

        for (const it of (msg.items || [])) {
          receiptByMessageId.set(Number(it.messageId), { readCount: Number(it.readCount), total: Number(it.total) });
          renderReceipt(Number(it.messageId));
        }
        return;
      }

      // DM history
      if (msg.type === "dm_history") {
        if (activeMode !== "dm") return;
        if (Number(msg.chatId) !== Number(activeDmChatId)) return;

        if (msg.otherUser) {
          activeDmOther = msg.otherUser;
          titleEl.textContent = `DM: ${activeDmOther.displayName}`;
          updateHeaderStatus();
        }

        const messages = msg.messages || [];
        for (const m of messages) addMsg(m);

        if (messages.length) sendReadDmIfPossible(messages[messages.length - 1].id);
        await refreshDmList();
        return;
      }

      if (msg.type === "dm_chat") {
        if (activeMode !== "dm") {
          await refreshDmList();
          return;
        }
        if (Number(msg.chatId) !== Number(activeDmChatId)) {
          await refreshDmList();
          return;
        }

        addMsg(msg.message);
        sendReadDmIfPossible(msg.message.id);
        await refreshDmList();
        return;
      }

      if (msg.type === "dm_read_progress") {
        if (activeMode !== "dm") return;
        if (Number(msg.chatId) !== Number(activeDmChatId)) return;

        receiptByMessageId.set(Number(msg.messageId), msg.read);
        renderReceipt(Number(msg.messageId));
        return;
      }

      if (msg.type === "error") {
        alert(msg.message || msg.code || "Error");
      }
    });
  }

  /* =======================
     DM create flow
  ======================= */
  newDmBtn.onclick = async () => {
    dmUserSelect.classList.toggle("hidden");
    dmOpenBtn.classList.toggle("hidden");
    if (!dmUserSelect.classList.contains("hidden") && dmUserSelect.options.length === 0) {
      const data = await api("/api/users");
      dmUserSelect.innerHTML = `<option value="">–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è‚Ä¶</option>` + (data.users || [])
        .map(u => `<option value="${u.id}">${esc(u.displayName)} (${esc(u.email)})</option>`).join("");
    }
  };

  dmOpenBtn.onclick = async () => {
    const uid = Number(dmUserSelect.value || 0);
    if (!uid) return;
    const opened = await api("/api/dm/open", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ userId: uid })
    });
    await refreshDmList();

    const chat = dmChats.find(c => Number(c.id) === Number(opened.chatId));
    if (chat) openDmChat(chat.id, chat.otherUser);
    else openDmChat(opened.chatId, null);
  };

  /* =======================
     Admin UI (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
  ======================= */
  function setAdminTab(tab) {
    for (const t of adminTabs) t.classList.toggle("active", t.dataset.adminTab === tab);
    for (const k of Object.keys(adminViews)) adminViews[k].classList.toggle("hidden", k !== tab);
  }
  adminTabs.forEach(t => t.onclick = () => setAdminTab(t.dataset.adminTab));

  openAdminBtn.onclick = async () => {
    adminCard.classList.remove("hidden");
    applyAdminTabPermissions();
    await refreshAdmin();
  };
  closeAdminBtn.onclick = () => adminCard.classList.add("hidden");

  function renderAccessPickers() {
    accessRoles.innerHTML = roles.map(r => `
      <label class="muted" style="display:flex; gap:8px; align-items:center; margin:6px 0;">
        <input type="checkbox" data-access-role="${r.id}" />
        ${esc(r.displayName)}
      </label>
    `).join("");

    accessUsers.innerHTML = users.map(u => `
      <label class="muted" style="display:flex; gap:8px; align-items:center; margin:6px 0;">
        <input type="checkbox" data-access-user="${u.id}" />
        ${esc(u.displayName)} <span class="muted">(${esc(u.email)})</span>
      </label>
    `).join("");
  }

  async function loadChannelAccessToUI(channelId) {
    const a = await api(`/api/admin/channels/${channelId}/access`);
    const roleSet = new Set((a.roleIds || []).map(Number));
    const userSet = new Set((a.userIds || []).map(Number));
    [...document.querySelectorAll("[data-access-role]")].forEach(chk => chk.checked = roleSet.has(Number(chk.dataset.accessRole)));
    [...document.querySelectorAll("[data-access-user]")].forEach(chk => chk.checked = userSet.has(Number(chk.dataset.accessUser)));
    accessMsg.textContent = "‚úÖ –î–æ—Å—Ç—É–ø –∑–∞–≥—Ä—É–∂–µ–Ω";
  }

  async function refreshAdmin() {
    const r = await api("/api/admin/roles");
    roles = r.roles || [];
    rolesList.innerHTML = roles.map(x => `<div><code>${esc(x.name)}</code> ‚Äî ${esc(x.displayName)} (id:${x.id})</div>`).join("");

    const u = await api("/api/admin/users");
    users = u.users || [];
    usersList.innerHTML = users.map(us => `
      <div class="card" style="margin-top:10px;">
        <div><b>${esc(us.displayName)}</b> <span class="pill">${esc(us.systemRole)}</span></div>
        <div class="muted">${esc(us.email)}</div>
        <div class="muted" id="userRoles_${us.id}">–†–æ–ª–∏: ‚Ä¶</div>

        <div class="row">
          <select data-user-role-select="${us.id}"><option value="">–í—ã–¥–∞—Ç—å —Ä–æ–ª—å‚Ä¶</option>
            ${roles.map(r => `<option value="${r.id}">${esc(r.displayName)}</option>`).join("")}
          </select>
          <button data-user-role-btn="${us.id}">–í—ã–¥–∞—Ç—å</button>
        </div>

        <div class="row" style="flex-wrap:wrap;">
          <button class="danger" data-user-role-remove-open="${us.id}">–°–Ω—è—Ç—å —Ä–æ–ª—å‚Ä¶</button>
          <select class="hidden" data-user-role-remove-select="${us.id}"><option value="">–í—ã–±–µ—Ä–∏ —Ä–æ–ª—å</option></select>
          <button class="hidden danger" data-user-role-remove-btn="${us.id}">–°–Ω—è—Ç—å</button>
        </div>
      </div>
    `).join("");

    for (const us of users) {
      (async () => {
        try {
          const ur = await api(`/api/admin/users/${us.id}/roles`);
          const list = ur.roles || [];
          const label = document.getElementById(`userRoles_${us.id}`);
          label.textContent = "–†–æ–ª–∏: " + (list.map(x => x.displayName).join(", ") || "‚Äî");
          const selRemove = document.querySelector(`[data-user-role-remove-select="${us.id}"]`);
          selRemove.innerHTML = `<option value="">–í—ã–±–µ—Ä–∏ —Ä–æ–ª—å –¥–ª—è —Å–Ω—è—Ç–∏—è</option>` + list.map(x => `<option value="${x.id}">${esc(x.displayName)}</option>`).join("");
        } catch {}
      })();

      const btnAdd = document.querySelector(`[data-user-role-btn="${us.id}"]`);
      const selAdd = document.querySelector(`[data-user-role-select="${us.id}"]`);
      btnAdd.onclick = async () => {
        const roleId = Number(selAdd.value || 0);
        if (!roleId) return;
        await api(`/api/admin/users/${us.id}/roles`, { method: "POST", headers: { "Content-Type":"application/json" }, body: JSON.stringify({ roleId })});
        await refreshAdmin();
      };

      const openRemove = document.querySelector(`[data-user-role-remove-open="${us.id}"]`);
      const selRemove = document.querySelector(`[data-user-role-remove-select="${us.id}"]`);
      const btnRemove = document.querySelector(`[data-user-role-remove-btn="${us.id}"]`);
      openRemove.onclick = () => { selRemove.classList.toggle("hidden"); btnRemove.classList.toggle("hidden"); };
      btnRemove.onclick = async () => {
        const roleId = Number(selRemove.value || 0);
        if (!roleId) return;
        await api(`/api/admin/users/${us.id}/roles/${roleId}`, { method: "DELETE" });
        await refreshAdmin();
      };
    }

    const ch = await api("/api/admin/channels");
    adminAllChannels = ch.channels || [];
    accessChannel.innerHTML = adminAllChannels.map(c => `<option value="${c.id}">#${esc(c.name)}${c.isPublic ? "" : " üîí"}</option>`).join("");
    renderAccessPickers();
    if (adminAllChannels.length) await loadChannelAccessToUI(Number(accessChannel.value));

    try {
      const a = await api("/api/audit");
      auditList.innerHTML = (a.logs || []).map(l => `
        <div class="card" style="margin-top:10px;">
          <div><b>${esc(l.action)}</b> <span class="muted">${esc(new Date(l.at).toLocaleString())}</span></div>
          <div class="muted">actor: ${esc(l.actor.displayName)} (${esc(l.actor.email)})</div>
          <div class="muted"><code>${esc(JSON.stringify(l.meta))}</code></div>
        </div>
      `).join("");
    } catch {
      auditList.innerHTML = `<div class="muted">–ê—É–¥–∏—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ OWNER/SUPERADMIN</div>`;
    }

    try {
      const d = await api("/api/admin/dm/chats");
      const chats = d.chats || [];
      dmAuditSelect.innerHTML = chats.map(c => {
        const last = c.last ? ` ‚Äî ${esc(c.last.text).slice(0, 30)}${c.last.text.length > 30 ? "‚Ä¶" : ""}` : "";
        return `<option value="${c.id}">${esc(c.a.displayName)} ‚Üî ${esc(c.b.displayName)}${last}</option>`;
      }).join("");
      dmAuditLog.textContent = chats.length ? "–í—ã–±–µ—Ä–∏ –¥–∏–∞–ª–æ–≥ –∏ –Ω–∞–∂–º–∏ ¬´–û—Ç–∫—Ä—ã—Ç—å¬ª." : "–ü–æ–∫–∞ –Ω–µ—Ç –ª–∏—á–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤.";
      dmAuditMessages.innerHTML = "";
    } catch {
      dmAuditSelect.innerHTML = `<option value="">–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ</option>`;
      dmAuditLog.textContent = "DM –∞—É–¥–∏—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ OWNER/SUPERADMIN";
      dmAuditMessages.innerHTML = "";
    }

    // invites
    try {
      const invs = await api("/api/admin/invites");
      const list = invs.invites || [];
      invitesList.innerHTML = list.map(it => {
        const link = `${location.origin}/?invite=${it.token}`;
        const exp = it.expiresAt ? new Date(it.expiresAt).toLocaleString() : "‚Äî";
        const used = `${it.usedCount}/${it.maxUses}`;
        const revoked = it.isRevoked ? " <span class=\"pill danger\">–æ—Ç–æ–∑–≤–∞–Ω</span>" : "";
        return `
          <div class="card" style="margin-top:10px;">
            <div style="display:flex; justify-content:space-between; gap:8px; align-items:center;">
              <div class="truncate"><b>–ò–Ω–≤–∞–π—Ç</b>${revoked} <span class="muted">–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: ${used} ‚Ä¢ –∏—Å—Ç–µ–∫–∞–µ—Ç: ${esc(exp)}</span></div>
              <div style="display:flex; gap:6px;">
                <button data-invite-copy="${it.token}">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
                <button class="danger" data-invite-revoke="${it.id}" ${it.isRevoked ? "disabled" : ""}>–û—Ç–æ–∑–≤–∞—Ç—å</button>
              </div>
            </div>
            <div class="small"><code>${esc(link)}</code></div>
          </div>
        `;
      }).join("") || `<div class="muted">–ü–æ–∫–∞ –Ω–µ—Ç –∏–Ω–≤–∞–π—Ç–æ–≤. –°–æ–∑–¥–∞–π –ø–µ—Ä–≤—ã–π.</div>`;

      // bind buttons
      [...document.querySelectorAll("[data-invite-copy]")].forEach(btn => {
        btn.onclick = async () => {
          const t = btn.dataset.inviteCopy;
          const link = `${location.origin}/?invite=${t}`;
          try { await navigator.clipboard.writeText(link); inviteMsg.textContent = "‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞"; }
          catch { inviteMsg.textContent = "–°–∫–æ–ø–∏—Ä—É–π –≤—Ä—É—á–Ω—É—é: " + link; }
        };
      });

      [...document.querySelectorAll("[data-invite-revoke]")].forEach(btn => {
        btn.onclick = async () => {
          const id = Number(btn.dataset.inviteRevoke || 0);
          if (!id) return;
          await api(`/api/admin/invites/${id}`, { method: "DELETE" });
          inviteMsg.textContent = "‚úÖ –ò–Ω–≤–∞–π—Ç –æ—Ç–æ–∑–≤–∞–Ω";
          await refreshAdmin();
        };
      });
    } catch {
      invitesList.innerHTML = `<div class="muted">–ò–Ω–≤–∞–π—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ ADMIN/OWNER</div>`;
    }

    applyAdminTabPermissions();
  }

  createRoleBtn.onclick = async () => {
    createRoleBtn.disabled = true;
    try {
      await api("/api/admin/roles", { method: "POST", headers: { "Content-Type":"application/json" }, body: JSON.stringify({ name: newRoleName.value, displayName: newRoleDisplay.value })});
      newRoleName.value = "";
      newRoleDisplay.value = "";
      await refreshAdmin();
    } catch (e) { alert(String(e.message || e)); }
    finally { createRoleBtn.disabled = false; }
  };

  createChannelBtn.onclick = async () => {
    createChannelBtn.disabled = true;
    try {
      await api("/api/admin/channels", { method: "POST", headers: { "Content-Type":"application/json" }, body: JSON.stringify({ name: newChannelName.value, isPublic: newChannelPublic.value === "true" })});
      newChannelName.value = "";
      await refreshAdmin();
      await refreshChannels();
    } catch (e) { alert(String(e.message || e)); }
    finally { createChannelBtn.disabled = false; }
  };

  loadAccessBtn.onclick = async () => {
    accessMsg.textContent = "";
    try { await loadChannelAccessToUI(Number(accessChannel.value)); }
    catch (e) { accessMsg.textContent = "‚ùå " + String(e.message || e); }
  };

  accessChannel.onchange = async () => {
    accessMsg.textContent = "";
    try { await loadChannelAccessToUI(Number(accessChannel.value)); } catch {}
  };

  saveAccessBtn.onclick = async () => {
    accessMsg.textContent = "";
    saveAccessBtn.disabled = true;
    try {
      const channelId = Number(accessChannel.value || 0);
      const roleIds = [...document.querySelectorAll("[data-access-role]")].filter(x => x.checked).map(x => Number(x.dataset.accessRole));
      const userIds = [...document.querySelectorAll("[data-access-user]")].filter(x => x.checked).map(x => Number(x.dataset.accessUser));
      await api(`/api/admin/channels/${channelId}/access`, { method: "POST", headers: { "Content-Type":"application/json" }, body: JSON.stringify({ roleIds, userIds })});
      accessMsg.textContent = "‚úÖ –î–æ—Å—Ç—É–ø —Å–æ—Ö—Ä–∞–Ω—ë–Ω";
      await refreshChannels();
    } catch (e) {
      accessMsg.textContent = "‚ùå " + String(e.message || e);
    } finally {
      saveAccessBtn.disabled = false;
    }
  };


  inviteCreateBtn.onclick = async () => {
    const maxUses = Number(inviteMaxUses.value || 1);
    const expiresInHours = Number(inviteExpiresHours.value || 0);
    await createInviteAndCopy(maxUses, expiresInHours);
    inviteMaxUses.value = "";
    inviteExpiresHours.value = "";
  };

  inviteQuick1.onclick = async () => {
    inviteMaxUses.value = "1";
    inviteExpiresHours.value = "0";
    await createInviteAndCopy(1, 0);
  };
  inviteQuick24.onclick = async () => {
    inviteMaxUses.value = "1";
    inviteExpiresHours.value = "24";
    await createInviteAndCopy(1, 24);
  };
  inviteQuick10.onclick = async () => {
    inviteMaxUses.value = "10";
    inviteExpiresHours.value = "0";
    await createInviteAndCopy(10, 0);
  };


  dmAuditLoadBtn.onclick = async () => {
    const chatId = Number(dmAuditSelect.value || 0);
    if (!chatId) return;
    dmAuditLog.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";
    dmAuditMessages.innerHTML = "";
    try {
      const data = await api(`/api/admin/dm/chats/${chatId}/messages`);
      const msgs = data.messages || [];
      dmAuditLog.textContent = `–°–æ–æ–±—â–µ–Ω–∏–π: ${msgs.length}. –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞–Ω –≤ –∞—É–¥–∏—Ç.`;
      dmAuditMessages.innerHTML = msgs.map(m => {
        const at = new Date(m.at).toLocaleString();
        return `
          <div class="card" style="margin-top:10px;">
            <div class="muted">${esc(m.from)} (${esc(m.fromEmail)}) ‚Ä¢ ${esc(at)}</div>
            <div>${esc(m.text)}</div>
          </div>
        `;
      }).join("");
    } catch (e) {
      dmAuditLog.textContent = "‚ùå " + String(e.message || e);
    }
  };

  /* =======================
     Boot
  ======================= */
  (async () => {
    try {
      // invite from URL: ?invite=TOKEN
      const params = new URLSearchParams(location.search);
      const inv = params.get("invite");
      hasInviteParam = Boolean(inv);

      // –µ—Å–ª–∏ –∏–Ω–≤–∞–π—Ç–∞ –Ω–µ—Ç ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º –≤–∫–ª–∞–¥–∫—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (—á—Ç–æ–±—ã –Ω–∏–∫—Ç–æ –Ω–µ –ø—ã—Ç–∞–ª—Å—è —Ä–µ–≥–∞—Ç—å—Å—è)
      tabRegister.classList.toggle("hidden", !hasInviteParam);

      const regInvEl = document.getElementById("regInvite");
      if (hasInviteParam && regInvEl) {
        regInvEl.value = inv;
        setAuthMode("register");
      } else {
        setAuthMode("login");
      }

      await loadPositions();

      const meResp = await api("/api/me");
      me = meResp.me;
      statusEl.textContent = "–°–µ—Å—Å–∏—è –∞–∫—Ç–∏–≤–Ω–∞";
      uiLoggedIn();
      await initWs();
      await refreshChannels();
      await refreshDmList();
    } catch {
      statusEl.textContent = "–ù—É–∂–Ω–æ –≤–æ–π—Ç–∏";
      uiLoggedOut();
      setAuthMode("login");
    }
  })();
</script>
</body>
</html>
